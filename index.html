<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpool Splitter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 1800% 1800%;
            animation: rainbow 8s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        @keyframes rainbow {
            0% { background-position: 0% 82%; }
            50% { background-position: 100% 19%; }
            100% { background-position: 0% 82%; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .section {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, button {
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        input {
            flex: 1;
            min-width: 150px;
        }

        button {
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .cars-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .car-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .car-visual {
            font-size: 4em;
            text-align: center;
            margin: 10px 0;
            animation: wiggle 2s infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .car-info {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .passengers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
        }

        .passenger-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .passenger-tag:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .passenger-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .unassigned-passengers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .unassigned-tag {
            background: #ff6b6b;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .unassigned-tag:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .unassigned-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .seats-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .editable-seats {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .editable-seats:hover {
            color: #667eea;
            font-weight: bold;
        }

        .event-input {
            width: 100%;
            font-size: 1.5em;
            text-align: center;
            padding: 15px;
            border: 3px solid #fff;
            border-radius: 15px;
            background: rgba(255,255,255,0.75);
            margin-bottom: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .event-input::placeholder {
            color: #aaa;
        }

        .save-btn {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: #45a049;
            transform: scale(1.02);
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .share-btn {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: rgba(118, 75, 162, 0.9);
            transform: scale(1.02);
        }

        .share-btn:active {
            transform: scale(0.98);
        }

        .clear-btn {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(238, 90, 82, 0.9);
            transform: scale(1.02);
        }

        .clear-btn:active {
            transform: scale(0.98);
        }

        .dancing-cookie {
            position: fixed;
            font-size: 4em;
            cursor: pointer;
            z-index: 1000;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: spin 2s linear infinite;
            transition: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        }

        .delete-car {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .input-group {
                flex-direction: column;
            }

            input, button {
                width: 100%;
            }
        }

        /* Game Boy Tetris Styles */
        .gameboy-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .gameboy-overlay.active {
            display: flex;
        }

        .gameboy {
            background: #9fa8a3;
            padding: 40px 30px;
            border-radius: 10px 10px 40px 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
        }

        .gameboy-screen {
            background: #9bbc0f;
            padding: 15px;
            border-radius: 5px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.3);
        }

        .tetris-canvas {
            display: block;
            background: #0f380f;
            border: 3px solid #306230;
            image-rendering: pixelated;
        }

        .gameboy-info {
            color: #0f380f;
            text-align: center;
            margin-top: 15px;
            font-family: monospace;
            font-weight: bold;
            font-size: 18px;
        }

        .gameboy-controls {
            margin-top: 20px;
            text-align: center;
            color: #0f380f;
            font-family: monospace;
            font-size: 14px;
        }

        .close-tetris {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #8b0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        /* TETRIS letter reveal */
        .tetris-reveal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20vw;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.15);
            z-index: 9999;
            pointer-events: none;
            letter-spacing: 0.1em;
            font-family: 'Arial Black', sans-serif;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
        }

        /* Mobile Touch Controls */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            gap: 10px;
            flex-direction: column;
            align-items: center;
        }

        .mobile-controls.active {
            display: flex;
        }

        .control-row {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(155, 188, 15, 0.9);
            border: 3px solid #306230;
            border-radius: 10px;
            width: 60px;
            height: 60px;
            font-size: 24px;
            color: #0f380f;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .control-btn:active {
            background: #8bac0f;
            transform: scale(0.95);
        }

        .music-prompt {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(155, 188, 15, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            border: 3px solid #306230;
            color: #0f380f;
            font-weight: bold;
            z-index: 10002;
            display: none;
            animation: pulse 1s infinite;
        }

        .music-prompt.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
        }

        /* Authentication Modal */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .auth-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .auth-modal h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .auth-modal p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #e0e0e0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .auth-btn:hover {
            background: #764ba2;
            transform: scale(1.02);
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            position: relative;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider::before {
            left: 0;
        }

        .auth-divider::after {
            right: 0;
        }

        .social-btn {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            background: white;
        }

        .social-btn:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }

        .social-btn.google {
            color: #4285F4;
        }

        .social-btn.apple {
            color: #000;
        }

        .auth-error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .user-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }

        .user-profile.show {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-email {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- User Profile Display -->
    <div class="user-profile" id="userProfile">
        <div class="user-email" id="userEmail"></div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Authentication Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>Welcome to CarBOOl Pro!</h2>
            <p>Sign in to save and share your carpools</p>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <div class="auth-error" id="authError"></div>

            <!-- Login Form -->
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="auth-btn" id="loginBtn">Login</button>
            </form>

            <!-- Sign Up Form -->
            <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
                <input type="email" class="auth-input" id="signupEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="signupPassword" placeholder="Password (min 6 chars)" required minlength="6">
                <input type="password" class="auth-input" id="signupConfirmPassword" placeholder="Confirm Password" required minlength="6">
                <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
            </form>

            <div class="auth-divider">or</div>

            <!-- Social Sign In -->
            <button class="social-btn google" onclick="handleGoogleSignIn()">
                <span>üîµ</span>
                Sign in with Google
            </button>
            <button class="social-btn apple" onclick="handleAppleSignIn()">
                <span>üçé</span>
                Sign in with Apple
            </button>
        </div>
    </div>

    <div class="container">
        <h1>üöó CarBOOl Splitter üöô</h1>
        <p class="subtitle">Who's riding with who?! ü§™</p>

        <input type="text" id="eventName" class="event-input" placeholder="Event Name (e.g., Beach Trip!)">

        <div class="section">
            <h2>Add Car üöó</h2>
            <div class="input-group">
                <input type="text" id="driverName" placeholder="Driver's name">
                <input type="number" id="seatCount" placeholder="# of seats" min="1" max="20">
                <button onclick="addCar()">Add Car</button>
            </div>
        </div>

        <div class="section">
            <h2>Add Friend üë´</h2>
            <div class="input-group">
                <input type="text" id="passengerName" placeholder="Friend's nickname">
                <button onclick="addPassenger()">Add Friend</button>
            </div>

            <h3 style="margin-top: 20px; color: #ff6b6b;">Unassigned Friends:</h3>
            <div class="unassigned-passengers" id="unassignedList"></div>
        </div>

        <div class="section">
            <h2>Carpool Lineup ‚úÖ</h2>
            <div class="cars-container" id="carsContainer"></div>
        </div>

        <button class="save-btn" onclick="saveData()">‚úÖ Auto Saved to Cloud</button>

        <button class="share-btn" onclick="shareEvent()">üîó Share with Friends</button>

        <button class="clear-btn" onclick="clearEverything()">üßπ Clear Everything</button>
    </div>

    <div class="dancing-cookie">üç™</div>

    <!-- TETRIS Letter Reveal -->
    <div class="tetris-reveal" id="tetrisReveal"></div>

    <!-- Game Boy Tetris Easter Egg -->
    <div class="gameboy-overlay" id="tetrisOverlay">
        <div class="gameboy">
            <button class="close-tetris" onclick="closeTetris()">√ó</button>
            <div class="gameboy-screen">
                <canvas id="tetrisCanvas" width="200" height="400" class="tetris-canvas"></canvas>
            </div>
            <div class="gameboy-info">
                <div>SCORE: <span id="tetrisScore">0</span></div>
                <div>LEVEL: <span id="tetrisLevel">1</span></div>
            </div>
            <div class="gameboy-controls">
                ‚Üê ‚Üí Move | ‚Üë Rotate | ‚Üì Drop<br>
                SPACE: Pause
            </div>
        </div>

        <!-- Mobile Touch Controls -->
        <div class="mobile-controls" id="mobileControls">
            <div class="control-row">
                <div class="control-btn" id="btnRotate">‚Üª</div>
            </div>
            <div class="control-row">
                <div class="control-btn" id="btnLeft">‚Üê</div>
                <div class="control-btn" id="btnDown">‚Üì</div>
                <div class="control-btn" id="btnRight">‚Üí</div>
            </div>
        </div>

        <!-- Music Prompt -->
        <div class="music-prompt" id="musicPrompt">üéµ Tap any button to start music!</div>
    </div>

    <!-- Hidden Audio Element for 8-bit MP3 -->
    <audio id="mp3Player" loop style="display:none;">
        <source src="the-return-of-the-8-bit-era-301292.mp3" type="audio/mpeg">
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAvrgOMpVvBLdwBxB4jC2Wo0y5A770Sx40",
            authDomain: "carbooler.firebaseapp.com",
            databaseURL: "https://carbooler-default-rtdb.firebaseio.com/",
            projectId: "carbooler",
            storageBucket: "carbooler.firebasestorage.app",
            messagingSenderId: "77908116123",
            appId: "1:77908116123:web:9a95e4703ba68ace8d3c3e",
            measurementId: "G-Q18PEXLHS4"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ============================================
        // AUTHENTICATION SYSTEM
        // ============================================

        let currentUser = null;

        // Monitor authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                console.log('User signed in:', user.email);

                // Hide auth modal
                document.getElementById('authOverlay').classList.remove('active');

                // Show user profile
                document.getElementById('userProfile').classList.add('show');
                document.getElementById('userEmail').textContent = user.email;

                // Initialize app with user's data
                initializeUserData();
            } else {
                // No user signed in - show auth modal
                currentUser = null;
                console.log('No user signed in');

                document.getElementById('authOverlay').classList.add('active');
                document.getElementById('userProfile').classList.remove('show');
            }
        });

        // Switch between login and signup tabs
        function switchAuthTab(tab) {
            const loginTab = document.querySelector('.auth-tab:nth-child(1)');
            const signupTab = document.querySelector('.auth-tab:nth-child(2)');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const authError = document.getElementById('authError');

            // Clear error
            authError.classList.remove('show');

            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
            } else {
                signupTab.classList.add('active');
                loginTab.classList.remove('active');
                signupForm.classList.add('active');
                loginForm.classList.remove('active');
            }
        }

        // Show error message
        function showAuthError(message) {
            const authError = document.getElementById('authError');
            authError.textContent = message;
            authError.classList.add('show');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please try again.';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Try again later.';
                }

                showAuthError(errorMessage);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        // Handle signup
        async function handleSignup(event) {
            event.preventDefault();

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const signupBtn = document.getElementById('signupBtn');

            // Validate passwords match
            if (password !== confirmPassword) {
                showAuthError('Passwords do not match!');
                return;
            }

            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Signup error:', error);
                let errorMessage = 'Signup failed. Please try again.';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Try logging in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                }

                showAuthError(errorMessage);
            } finally {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        }

        // Handle Google Sign In
        async function handleGoogleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();

            try {
                await auth.signInWithPopup(provider);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Google sign in error:', error);
                let errorMessage = 'Google sign in failed. Please try again.';

                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign in cancelled.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Pop-up blocked. Please allow pop-ups and try again.';
                }

                showAuthError(errorMessage);
            }
        }

        // Handle Apple Sign In
        async function handleAppleSignIn() {
            const provider = new firebase.auth.OAuthProvider('apple.com');

            try {
                await auth.signInWithPopup(provider);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Apple sign in error:', error);
                let errorMessage = 'Apple sign in failed. Please try again.';

                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign in cancelled.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Pop-up blocked. Please allow pop-ups and try again.';
                }

                showAuthError(errorMessage);
            }
        }

        // Handle logout
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    // onAuthStateChanged will handle showing the auth modal
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed. Please try again.');
                }
            }
        }

        // Initialize user's data after authentication
        function initializeUserData() {
            // This will be called after user signs in
            // Set up the database reference with user-specific path
            eventId = getOrCreateEventId();
            dbRef = database.ref(`users/${currentUser.uid}/events/${eventId}`);
            loadData();
        }

        // ============================================
        // END AUTHENTICATION SYSTEM
        // ============================================

        // Get or create event ID from URL parameter
        let eventId = null;
        let dbRef = null;

        function getOrCreateEventId() {
            const params = new URLSearchParams(window.location.search);
            const urlEventId = params.get('e');

            if (urlEventId) {
                // Joining specific event from URL
                console.log('Joining event:', urlEventId);
                return urlEventId;
            } else {
                // Use default shared event - everyone accessing base URL sees same data
                console.log('Using default shared event');
                return 'default';
            }
        }

        eventId = getOrCreateEventId();
        dbRef = database.ref(`events/${eventId}`);

        let cars = [];
        let unassignedPassengers = [];
        let selectedEmoji = 'üöô';
        let isSaving = false;

        // Security: Rate limiting to prevent spam
        let lastActionTime = 0;
        const ACTION_COOLDOWN = 500; // 500ms between actions

        function isRateLimited() {
            const now = Date.now();
            if (now - lastActionTime < ACTION_COOLDOWN) {
                alert('Slow down! You\'re going too fast üêå');
                return true;
            }
            lastActionTime = now;
            return false;
        }

        // Security: Sanitize user input to prevent XSS attacks
        function sanitizeInput(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Security: Validate input length and content
        function validateInput(input, maxLength, fieldName) {
            if (!input || input.trim().length === 0) {
                alert(`Please enter a ${fieldName}!`);
                return false;
            }
            if (input.length > maxLength) {
                alert(`${fieldName} must be ${maxLength} characters or less!`);
                return false;
            }
            // Block obviously malicious patterns
            if (/<script|javascript:|onerror|onclick/i.test(input)) {
                alert('Invalid characters detected!');
                return false;
            }
            return true;
        }

        // Auto-save function - now saves to Firebase!
        function autoSave() {
            if (isSaving) return; // Don't save if already saving

            isSaving = true;

            const eventName = document.getElementById('eventName').value.trim();

            // Security: Sanitize and limit event name length
            const sanitizedEventName = eventName.length > 100
                ? sanitizeInput(eventName.substring(0, 100))
                : sanitizeInput(eventName);

            // Use transactions to update specific fields atomically
            // This prevents overwriting teammates' concurrent edits
            const updates = {};
            updates[`events/${eventId}/eventName`] = sanitizedEventName;
            updates[`events/${eventId}/cars`] = cars;
            updates[`events/${eventId}/unassignedPassengers`] = unassignedPassengers;
            updates[`events/${eventId}/lastUpdated`] = firebase.database.ServerValue.TIMESTAMP;

            // Use update() instead of set() to avoid overwriting entire object
            database.ref().update(updates).then(() => {
                console.log('Saved to Firebase!');
                setTimeout(() => {
                    isSaving = false;
                }, 500);
            }).catch(error => {
                console.error('Error saving to Firebase:', error);
                alert('Save Error: ' + error.message + '\n\nCheck that:\n1. Firebase Realtime Database is enabled\n2. Security rules are published\n3. You have internet connection');
                isSaving = false;
            });
        }

        function addCar() {
            // Security: Rate limiting
            if (isRateLimited()) return;

            const driverName = document.getElementById('driverName').value.trim();
            const seatCount = parseInt(document.getElementById('seatCount').value);

            // Security: Validate driver name
            if (!validateInput(driverName, 50, 'driver name')) {
                return;
            }

            // Validate seat count
            if (!seatCount || seatCount < 1 || seatCount > 20) {
                alert('Please enter a valid seat count (1-20)!');
                return;
            }

            // Security: Sanitize driver name before storing
            const sanitizedName = sanitizeInput(driverName);

            cars.push({
                id: Date.now(),
                driver: sanitizedName,
                seats: seatCount,
                passengers: [],
                emoji: selectedEmoji
            });

            document.getElementById('driverName').value = '';
            document.getElementById('seatCount').value = '';

            renderCars();
            autoSave();
        }

        function addPassenger() {
            // Security: Rate limiting
            if (isRateLimited()) return;

            const passengerName = document.getElementById('passengerName').value.trim();

            // Security: Validate friend name
            if (!validateInput(passengerName, 50, 'friend name')) {
                return;
            }

            // Security: Sanitize friend name before storing
            const sanitizedName = sanitizeInput(passengerName);

            unassignedPassengers.push({
                id: Date.now(),
                name: sanitizedName
            });

            document.getElementById('passengerName').value = '';
            renderUnassigned();
            autoSave();
        }

        function assignPassenger(passengerId, carId) {
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            const car = cars.find(c => c.id === carId);

            if (!passenger || !car) return;

            if (car.passengers.length >= car.seats) {
                alert('This car is full!');
                return;
            }

            car.passengers.push(passenger);
            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);

            renderCars();
            renderUnassigned();
            autoSave();
        }

        function removePassengerFromCar(carId, passengerId) {
            const car = cars.find(c => c.id === carId);
            const passenger = car.passengers.find(p => p.id === passengerId);

            if (!passenger) return;

            car.passengers = car.passengers.filter(p => p.id !== passengerId);
            unassignedPassengers.push(passenger);

            renderCars();
            renderUnassigned();
            autoSave();
        }

        function deleteCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (car) {
                unassignedPassengers.push(...car.passengers);
            }
            cars = cars.filter(c => c.id !== carId);
            renderCars();
            renderUnassigned();
            autoSave();
        }

        function editSeats(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;

            const newSeats = prompt(`Change number of seats for ${car.driver}'s car:`, car.seats);
            if (newSeats === null) return; // User cancelled

            const seatCount = parseInt(newSeats);
            if (isNaN(seatCount) || seatCount < 1) {
                alert('Please enter a valid number of seats!');
                return;
            }

            if (seatCount < car.passengers.length) {
                alert(`Cannot set seats to ${seatCount} because there are already ${car.passengers.length} friends in this car!`);
                return;
            }

            car.seats = seatCount;
            renderCars();
            autoSave();
        }

        function renderCars() {
            const container = document.getElementById('carsContainer');

            if (cars.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No cars yet! Add one above.</p>';
                return;
            }

            container.innerHTML = cars.map(car => {
                // Ensure passengers array exists
                if (!car.passengers) {
                    car.passengers = [];
                }
                const isFull = car.passengers.length >= car.seats;
                return `
                    <div class="car-card ${isFull ? 'full' : ''}" onclick="handleCarClick(event, ${car.id})">
                        <button class="delete-car" onclick="event.stopPropagation(); deleteCar(${car.id})">√ó</button>
                        <div class="car-visual">${car.emoji}</div>
                        <div class="car-info">
                            Driver: ${car.driver}
                        </div>
                        <div class="seats-info">
                            ${car.passengers.length} / <span class="editable-seats" onclick="event.stopPropagation(); editSeats(${car.id})">${car.seats}</span> seats filled ${isFull ? '(FULL!)' : ''}
                        </div>
                        <div class="passengers-list">
                            ${car.passengers.map(p => `
                                <div class="passenger-tag" onclick="event.stopPropagation(); removePassengerFromCar(${car.id}, ${p.id})">
                                    ${p.name}
                                    <span class="remove">√ó</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeUnassignedFriend(passengerId) {
            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);
            renderUnassigned();
            autoSave();
        }

        function renderUnassigned() {
            const container = document.getElementById('unassignedList');

            if (unassignedPassengers.length === 0) {
                container.innerHTML = '<p style="color: #999;">All friends are assigned!</p>';
                return;
            }

            container.innerHTML = unassignedPassengers.map(p => `
                <div class="unassigned-tag" data-passenger-id="${p.id}">
                    ${p.name}
                    <span class="remove" onclick="event.stopPropagation(); removeUnassignedFriend(${p.id})">√ó</span>
                </div>
            `).join('');

            // Add click handlers for drag-to-assign
            container.querySelectorAll('.unassigned-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const passengerId = parseInt(this.dataset.passengerId);
                    selectPassengerForAssignment(passengerId);
                });
            });
        }

        let selectedPassengerId = null;

        function selectPassengerForAssignment(passengerId) {
            selectedPassengerId = passengerId;
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            alert(`Click on a car to assign ${passenger.name}! üöó`);
        }

        function handleCarClick(event, carId) {
            if (selectedPassengerId) {
                assignPassenger(selectedPassengerId, carId);
                selectedPassengerId = null;
            }
        }

        // Manual save function (auto-save happens automatically in background)
        function saveData() {
            autoSave();
            alert('Saved to cloud! ‚òÅÔ∏è');
        }

        // Clear everything function
        function clearEverything() {
            if (confirm('Going to clear everything now.')) {
                // Clear local data
                cars = [];
                unassignedPassengers = [];
                document.getElementById('eventName').value = '';

                // Clear Firebase
                dbRef.remove().then(() => {
                    console.log('Firebase data cleared');
                }).catch(error => {
                    console.error('Error clearing Firebase:', error);
                });

                // Re-render
                renderCars();
                renderUnassigned();

                alert('Everything cleared! üßπ');
            }
        }

        // Share event with friends
        async function shareEvent() {
            if (!currentUser) {
                alert('You must be logged in to share events!');
                return;
            }

            const eventName = document.getElementById('eventName').value.trim();
            if (!eventName) {
                alert('Please add an event name before sharing!');
                return;
            }

            if (cars.length === 0 && unassignedPassengers.length === 0) {
                alert('Please add some cars or friends before sharing!');
                return;
            }

            try {
                // Generate unique share ID
                const shareId = generateShareId();

                // Save event to shared location
                const sharedData = {
                    ownerId: currentUser.uid,
                    ownerEmail: currentUser.email,
                    eventName: sanitizeInput(eventName),
                    cars: cars,
                    unassignedPassengers: unassignedPassengers,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref(`shared/${shareId}`).set(sharedData);

                // Generate share URL
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;

                // Try to copy to clipboard
                try {
                    await navigator.clipboard.writeText(shareUrl);
                    alert(`Share link copied to clipboard! üìã\n\n${shareUrl}\n\nAnyone with this link can view and edit this carpool.`);
                } catch (clipboardError) {
                    // Clipboard API failed, show link in prompt
                    prompt('Share this link with your friends! (Copy it manually):', shareUrl);
                }

            } catch (error) {
                console.error('Share error:', error);
                alert('Failed to create share link. Please try again.');
            }
        }

        // Generate random share ID
        function generateShareId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            for (let i = 0; i < 8; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        // Check if user is accessing a shared event
        function checkForSharedEvent() {
            const params = new URLSearchParams(window.location.search);
            const shareId = params.get('share');

            if (shareId) {
                console.log('Loading shared event:', shareId);

                // Load shared event data
                database.ref(`shared/${shareId}`).on('value', (snapshot) => {
                    const data = snapshot.val();

                    if (!data) {
                        alert('This shared event does not exist or has been deleted.');
                        return;
                    }

                    // Load shared event into app
                    document.getElementById('eventName').value = data.eventName || '';
                    cars = data.cars || [];
                    unassignedPassengers = data.unassignedPassengers || [];

                    // Ensure all cars have passengers arrays
                    cars.forEach(car => {
                        if (!car.passengers) {
                            car.passengers = [];
                        }
                    });

                    renderCars();
                    renderUnassigned();

                    // Show sharing info
                    const ownerInfo = data.ownerEmail ? ` (shared by ${data.ownerEmail})` : '';
                    console.log(`Loaded shared event${ownerInfo}`);
                });

                // Override save function to save to shared location
                const originalAutoSave = autoSave;
                autoSave = function() {
                    if (isSaving) return;
                    isSaving = true;

                    const eventName = document.getElementById('eventName').value.trim();
                    const sanitizedEventName = eventName.length > 100
                        ? sanitizeInput(eventName.substring(0, 100))
                        : sanitizeInput(eventName);

                    const updates = {
                        eventName: sanitizedEventName,
                        cars: cars,
                        unassignedPassengers: unassignedPassengers,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    };

                    database.ref(`shared/${shareId}`).update(updates).then(() => {
                        console.log('Shared event updated!');
                        setTimeout(() => {
                            isSaving = false;
                        }, 500);
                    }).catch(error => {
                        console.error('Error updating shared event:', error);
                        isSaving = false;
                    });
                };
            }
        }

        function loadData() {
            // Real-time listener - updates whenever anyone makes a change!
            dbRef.on('value', (snapshot) => {
                // Don't update if we're currently saving
                if (isSaving) {
                    console.log('Skipping Firebase update - currently saving');
                    return;
                }

                const data = snapshot.val();

                // If no data exists yet (first time), just render empty state
                if (!data) {
                    console.log('No data in Firebase yet');
                    return;
                }

                console.log('Loading data from Firebase:', data);
                document.getElementById('eventName').value = data.eventName || '';
                cars = data.cars || [];
                unassignedPassengers = data.unassignedPassengers || [];

                // Ensure all cars have passengers arrays
                cars.forEach(car => {
                    if (!car.passengers) {
                        car.passengers = [];
                    }
                });

                renderCars();
                renderUnassigned();
            });
        }

        // Add auto-save to event name input
        document.getElementById('eventName').addEventListener('input', autoSave);

        // Allow Enter key to submit
        document.getElementById('driverName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('seatCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('passengerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addPassenger();
        });

        // Check for shared event on page load
        checkForSharedEvent();

        // Initial render
        renderCars();
        renderUnassigned();

        // DVD-style bouncing cookie
        const cookie = document.querySelector('.dancing-cookie');
        let x = Math.random() * (window.innerWidth - 100);
        let y = Math.random() * (window.innerHeight - 100);
        let xSpeed = 2;
        let ySpeed = 2;

        // TETRIS Easter Egg - Click cookie 6 times to spell TETRIS
        let cookieClickCount = 0;
        const tetrisLetters = ['T', 'E', 'T', 'R', 'I', 'S'];
        const tetrisRevealDiv = document.getElementById('tetrisReveal');
        let cookieResetTimer = null;

        cookie.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            cookieClickCount++;

            // Reset timer - if you don't complete within 5 seconds, reset
            clearTimeout(cookieResetTimer);
            cookieResetTimer = setTimeout(() => {
                cookieClickCount = 0;
                tetrisRevealDiv.textContent = '';
            }, 5000);

            if (cookieClickCount <= 6) {
                // Build up TETRIS letter by letter
                const currentWord = tetrisLetters.slice(0, cookieClickCount).join('');
                tetrisRevealDiv.textContent = currentWord;

                if (cookieClickCount === 6) {
                    // Spell complete! Launch Tetris
                    clearTimeout(cookieResetTimer);

                    setTimeout(() => {
                        tetrisRevealDiv.textContent = '';
                        cookieClickCount = 0;
                        openTetris();
                    }, 500);
                }
            }
        });

        function moveCookie() {
            x += xSpeed;
            y += ySpeed;

            const cookieSize = 64; // Approximate size of the emoji

            // Bounce off edges
            if (x + cookieSize >= window.innerWidth || x <= 0) {
                xSpeed = -xSpeed;
            }
            if (y + cookieSize >= window.innerHeight || y <= 0) {
                ySpeed = -ySpeed;
            }

            cookie.style.left = x + 'px';
            cookie.style.top = y + 'px';

            requestAnimationFrame(moveCookie);
        }

        moveCookie();

        // ============================================
        // TETRIS EASTER EGG - GAME BOY STYLE
        // ============================================

        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 20;
        const COLORS = ['#0f380f', '#306230', '#0f380f', '#8bac0f', '#9bbc0f'];

        let tetrisCanvas, tetrisCtx;
        let tetrisBoard = [];
        let currentPiece = null;
        let tetrisScore = 0;
        let tetrisLevel = 1;
        let tetrisGameRunning = false;
        let tetrisGameLoop = null;
        let tetrisPaused = false;
        let tetrisDropCounter = 0;
        let tetrisDropInterval = 1000;

        // Tetris pieces (tetrominoes)
        const PIECES = {
            I: [[1,1,1,1]],
            O: [[1,1],[1,1]],
            T: [[0,1,0],[1,1,1]],
            S: [[0,1,1],[1,1,0]],
            Z: [[1,1,0],[0,1,1]],
            J: [[1,0,0],[1,1,1]],
            L: [[0,0,1],[1,1,1]]
        };

        function initTetris() {
            tetrisCanvas = document.getElementById('tetrisCanvas');
            tetrisCtx = tetrisCanvas.getContext('2d');

            // Initialize board
            tetrisBoard = Array(ROWS).fill().map(() => Array(COLS).fill(0));

            tetrisScore = 0;
            tetrisLevel = 1;
            updateTetrisUI();

            spawnPiece();

            // Music already started on cookie click - don't start again
        }

        function spawnPiece() {
            const pieces = Object.keys(PIECES);
            const randomPiece = pieces[Math.floor(Math.random() * pieces.length)];
            currentPiece = {
                shape: PIECES[randomPiece],
                x: Math.floor(COLS / 2) - 1,
                y: 0,
                color: 1
            };

            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                // Game over
                tetrisGameRunning = false;
                alert('Game Over! Score: ' + tetrisScore);
                closeTetris();
            }
        }

        function collision(x, y, shape) {
            for (let row = 0; row < shape.length; row++) {
                for (let col = 0; col < shape[row].length; col++) {
                    if (shape[row][col] &&
                        (y + row >= ROWS ||
                         x + col < 0 ||
                         x + col >= COLS ||
                         tetrisBoard[y + row] && tetrisBoard[y + row][x + col])) {
                        return true;
                    }
                }
            }
            return false;
        }

        function merge() {
            currentPiece.shape.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value) {
                        tetrisBoard[currentPiece.y + y][currentPiece.x + x] = currentPiece.color;
                    }
                });
            });
        }

        function rotate(shape) {
            const rotated = shape[0].map((_, i) =>
                shape.map(row => row[i]).reverse()
            );
            return rotated;
        }

        function clearLines() {
            let linesCleared = 0;
            for (let row = ROWS - 1; row >= 0; row--) {
                if (tetrisBoard[row].every(cell => cell !== 0)) {
                    tetrisBoard.splice(row, 1);
                    tetrisBoard.unshift(Array(COLS).fill(0));
                    linesCleared++;
                    row++; // Check same row again
                }
            }
            if (linesCleared > 0) {
                tetrisScore += linesCleared * 100 * tetrisLevel;
                tetrisLevel = Math.floor(tetrisScore / 1000) + 1;
                tetrisDropInterval = Math.max(100, 1000 - (tetrisLevel * 100));
                updateTetrisUI();
            }
        }

        function movePiece(dir) {
            currentPiece.x += dir;
            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                currentPiece.x -= dir;
            }
        }

        function dropPiece() {
            currentPiece.y++;
            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                currentPiece.y--;
                merge();
                clearLines();
                spawnPiece();
            }
            tetrisDropCounter = 0;
        }

        function hardDrop() {
            while (!collision(currentPiece.x, currentPiece.y + 1, currentPiece.shape)) {
                currentPiece.y++;
            }
            merge();
            clearLines();
            spawnPiece();
        }

        function rotatePiece() {
            const rotated = rotate(currentPiece.shape);
            if (!collision(currentPiece.x, currentPiece.y, rotated)) {
                currentPiece.shape = rotated;
            }
        }

        function drawTetris() {
            // Clear canvas with Game Boy green
            tetrisCtx.fillStyle = '#0f380f';
            tetrisCtx.fillRect(0, 0, tetrisCanvas.width, tetrisCanvas.height);

            // Draw board
            tetrisBoard.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell) {
                        drawBlock(x, y, '#8bac0f');
                    }
                });
            });

            // Draw current piece
            if (currentPiece) {
                currentPiece.shape.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            drawBlock(currentPiece.x + x, currentPiece.y + y, '#9bbc0f');
                        }
                    });
                });
            }
        }

        function drawBlock(x, y, color) {
            tetrisCtx.fillStyle = color;
            tetrisCtx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
            tetrisCtx.strokeStyle = '#306230';
            tetrisCtx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
        }

        function updateTetrisUI() {
            document.getElementById('tetrisScore').textContent = tetrisScore;
            document.getElementById('tetrisLevel').textContent = tetrisLevel;
        }

        function tetrisUpdate(deltaTime) {
            if (!tetrisGameRunning || tetrisPaused) return;

            tetrisDropCounter += deltaTime;
            if (tetrisDropCounter > tetrisDropInterval) {
                dropPiece();
            }

            drawTetris();
        }

        let lastTetrisTime = 0;
        function tetrisLoop(time = 0) {
            const deltaTime = time - lastTetrisTime;
            lastTetrisTime = time;

            tetrisUpdate(deltaTime);

            if (tetrisGameRunning) {
                tetrisGameLoop = requestAnimationFrame(tetrisLoop);
            }
        }

        // Tetris controls
        document.addEventListener('keydown', (e) => {
            if (!tetrisGameRunning) return;

            switch(e.key) {
                case 'ArrowLeft':
                    movePiece(-1);
                    break;
                case 'ArrowRight':
                    movePiece(1);
                    break;
                case 'ArrowDown':
                    dropPiece();
                    break;
                case 'ArrowUp':
                    rotatePiece();
                    break;
                case ' ':
                    tetrisPaused = !tetrisPaused;
                    break;
            }
        });

        function openTetris() {
            document.getElementById('tetrisOverlay').classList.add('active');
            document.getElementById('mobileControls').classList.add('active');
            tetrisGameRunning = true;
            initTetris();
            tetrisLoop();

            // Play the 8-bit MP3 track
            const mp3Player = document.getElementById('mp3Player');
            mp3Player.volume = 0.3; // Set volume to 30%
            mp3Player.play().catch(err => {
                console.log('Audio play failed:', err);
                document.getElementById('musicPrompt').classList.add('show');
            });
        }

        function closeTetris() {
            document.getElementById('tetrisOverlay').classList.remove('active');
            document.getElementById('mobileControls').classList.remove('active');
            document.getElementById('musicPrompt').classList.remove('show');
            tetrisGameRunning = false;
            if (tetrisGameLoop) {
                cancelAnimationFrame(tetrisGameLoop);
            }

            // Stop the MP3 player
            const mp3Player = document.getElementById('mp3Player');
            mp3Player.pause();
            mp3Player.currentTime = 0;
        }

        // Mobile touch controls - also resume audio on first touch (iOS fix)
        function handleTouchControl(callback) {
            return function(e) {
                e.preventDefault();

                // Try to play MP3 on first touch (iOS requirement)
                const mp3Player = document.getElementById('mp3Player');
                if (mp3Player.paused) {
                    mp3Player.play().then(() => {
                        document.getElementById('musicPrompt').classList.remove('show');
                    }).catch(err => {
                        console.log('Audio play failed on touch:', err);
                    });
                }

                if (tetrisGameRunning) callback();
            };
        }

        document.getElementById('btnLeft').addEventListener('touchstart', handleTouchControl(() => movePiece(-1)));
        document.getElementById('btnRight').addEventListener('touchstart', handleTouchControl(() => movePiece(1)));
        document.getElementById('btnDown').addEventListener('touchstart', handleTouchControl(() => dropPiece()));
        document.getElementById('btnRotate').addEventListener('touchstart', handleTouchControl(() => rotatePiece()));

        // Desktop shortcut: Press 'T' three times quickly
        let tPressCount = 0;
        let tPressTimer = null;
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                tPressCount++;
                clearTimeout(tPressTimer);

                if (tPressCount >= 3 && !tetrisGameRunning) {
                    tPressCount = 0;
                    openTetris();
                } else {
                    tPressTimer = setTimeout(() => {
                        tPressCount = 0;
                    }, 1000);
                }
            }
        });
    </script>
</body>
</html>
