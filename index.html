<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpool Splitter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 1800% 1800%;
            animation: rainbow 8s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        @keyframes rainbow {
            0% { background-position: 0% 82%; }
            50% { background-position: 100% 19%; }
            100% { background-position: 0% 82%; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .section {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        /* Event Details Styling */
        .event-details-section {
            background: rgba(255, 255, 255, 0.9);
        }

        .date-time-row {
            display: flex;
            gap: 15px;
            margin-bottom: 0;
        }

        .date-time-row .detail-group {
            flex: 1;
            margin-bottom: 20px;
        }

        .detail-group {
            margin-bottom: 20px;
            overflow: hidden;
        }

        .detail-group input,
        .detail-group textarea {
            max-width: 100%;
        }

        .detail-group label {
            display: block;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .detail-input {
            width: 100%;
            max-width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
            box-sizing: border-box;
            display: block;
        }

        .detail-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Ensure date and time inputs stay within bounds */
        input[type="date"].detail-input,
        input[type="time"].detail-input {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            padding: 12px !important;
            margin: 0 !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Override browser default date/time picker styles */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        .detail-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .detail-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .address-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .address-group .detail-input {
            flex: 1;
            min-width: 200px;
        }

        .maps-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .maps-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, button {
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        input {
            flex: 1;
            min-width: 150px;
        }

        button {
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .cars-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .car-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .car-visual {
            font-size: 4em;
            text-align: center;
            margin: 10px 0;
            animation: wiggle 2s infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .car-info {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .passengers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
        }

        .passenger-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .passenger-tag:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .passenger-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .unassigned-passengers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .unassigned-tag {
            background: #ff6b6b;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .unassigned-tag:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .unassigned-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .seats-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .editable-seats {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .editable-seats:hover {
            color: #667eea;
            font-weight: bold;
        }

        .event-input {
            width: 100%;
            font-size: 1.5em;
            text-align: center;
            padding: 15px;
            border: 3px solid #fff;
            border-radius: 15px;
            background: rgba(255,255,255,0.75);
            margin-bottom: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .event-input::placeholder {
            color: #aaa;
        }

        .save-btn {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: #45a049;
            transform: scale(1.02);
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .share-btn {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: rgba(118, 75, 162, 0.9);
            transform: scale(1.02);
        }

        .share-btn:active {
            transform: scale(0.98);
        }

        .clear-btn {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(238, 90, 82, 0.9);
            transform: scale(1.02);
        }

        .clear-btn:active {
            transform: scale(0.98);
        }

        .dancing-cookie {
            position: fixed;
            font-size: 4em;
            cursor: pointer;
            z-index: 1000;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: spin 2s linear infinite;
            transition: opacity 0.3s;
        }

        .dancing-cookie.hidden {
            opacity: 0;
            pointer-events: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        }

        .delete-car {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .input-group {
                flex-direction: column;
            }

            input, button {
                width: 100%;
            }
        }

        /* Game Boy Tetris Styles */
        .gameboy-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .gameboy-overlay.active {
            display: flex;
        }

        .gameboy {
            background: #9fa8a3;
            padding: 40px 30px;
            border-radius: 10px 10px 40px 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
        }

        .gameboy-screen {
            background: #9bbc0f;
            padding: 15px;
            border-radius: 5px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.3);
        }

        .tetris-canvas {
            display: block;
            background: #0f380f;
            border: 3px solid #306230;
            image-rendering: pixelated;
        }

        .gameboy-info {
            color: #0f380f;
            text-align: center;
            margin-top: 15px;
            font-family: monospace;
            font-weight: bold;
            font-size: 18px;
        }

        .gameboy-controls {
            margin-top: 20px;
            text-align: center;
            color: #0f380f;
            font-family: monospace;
            font-size: 14px;
        }

        .close-tetris {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #8b0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        /* TETRIS letter reveal */
        .tetris-reveal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20vw;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.15);
            z-index: 9999;
            pointer-events: none;
            letter-spacing: 0.1em;
            font-family: 'Arial Black', sans-serif;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
        }

        /* Mobile Touch Controls */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            gap: 10px;
            flex-direction: column;
            align-items: center;
        }

        .mobile-controls.active {
            display: flex;
        }

        .control-row {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(155, 188, 15, 0.9);
            border: 3px solid #306230;
            border-radius: 10px;
            width: 60px;
            height: 60px;
            font-size: 24px;
            color: #0f380f;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .control-btn:active {
            background: #8bac0f;
            transform: scale(0.95);
        }

        .music-prompt {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(155, 188, 15, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            border: 3px solid #306230;
            color: #0f380f;
            font-weight: bold;
            z-index: 10002;
            display: none;
            animation: pulse 1s infinite;
        }

        .music-prompt.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
        }

        /* Authentication Modal */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .auth-overlay.active {
            display: flex;
        }

        .auth-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 360px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .auth-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .auth-car {
            font-size: 2em;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .auth-modal h2 {
            text-align: center;
            color: #667eea;
            margin: 0;
            font-size: 1.6em;
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .auth-tab {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #667eea;
            text-decoration: none;
            padding: 8px;
            transition: all 0.2s;
        }

        .auth-tab:hover {
            text-decoration: underline;
            color: #764ba2;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }

        .auth-btn:hover {
            background: #764ba2;
            transform: scale(1.01);
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .forgot-password-link {
            display: block;
            text-align: center;
            color: #667eea;
            font-size: 13px;
            text-decoration: none;
            margin-top: 10px;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        .auth-divider-inline {
            text-align: center;
            margin: 15px 0;
            color: #999;
            position: relative;
            font-size: 13px;
        }

        .auth-divider-inline::before,
        .auth-divider-inline::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 42%;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider-inline::before {
            left: 0;
        }

        .auth-divider-inline::after {
            right: 0;
        }

        .social-buttons-top {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .social-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .social-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .social-btn svg {
            width: 20px;
            height: 20px;
        }

        .auth-error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        /* Onboarding Modal */
        .onboarding-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 30000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .onboarding-overlay.active {
            display: flex;
        }

        .onboarding-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .onboarding-modal h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }

        .onboarding-event-name {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .onboarding-question {
            font-weight: bold;
            color: #667eea;
            margin: 20px 0 10px;
            font-size: 1.1em;
        }

        .onboarding-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .onboarding-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .onboarding-subtext {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 20px;
        }

        .onboarding-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .onboarding-btn {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .driver-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.05);
        }

        .rider-btn:hover {
            border-color: #4CAF50;
            background: #f0fff4;
            transform: scale(1.05);
        }

        .emoji-picker-mini {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .emoji-option {
            font-size: 2em;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .emoji-option:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }

        .emoji-option.selected {
            background: #667eea;
            transform: scale(1.3);
        }

        .onboarding-btn-primary {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .onboarding-btn-primary:hover {
            background: #764ba2;
            transform: scale(1.02);
        }

        .onboarding-btn-secondary {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .onboarding-btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .onboarding-car-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .onboarding-car-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .onboarding-car-card:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .onboarding-car-info {
            flex: 1;
        }

        .onboarding-car-driver {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .onboarding-car-seats {
            color: #666;
            font-size: 0.9em;
        }

        .onboarding-join-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .onboarding-join-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .onboarding-join-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Cookie Menu */
        .cookie-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            z-index: 10001;
            min-width: 250px;
        }

        .cookie-menu.show {
            display: block;
        }

        .cookie-menu button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cookie-menu .menu-logout {
            background: #ff6b6b;
            color: white;
        }

        .cookie-menu .menu-logout:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .cookie-menu .menu-share {
            background: #667eea;
            color: white;
        }

        .cookie-menu .menu-share:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .cookie-menu .menu-clear {
            background: #ff9800;
            color: white;
        }

        .cookie-menu .menu-clear:hover {
            background: #e68900;
            transform: scale(1.05);
        }

        .cookie-menu .menu-close {
            background: #e0e0e0;
            color: #666;
        }

        .cookie-menu .menu-close:hover {
            background: #ccc;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <div class="auth-header">
                <span class="auth-car">üöó</span>
                <h2>Carpool Splitter</h2>
                <span class="auth-car">üöô</span>
            </div>

            <div class="auth-error" id="authError"></div>

            <!-- Login Form -->
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <!-- Social Sign In First -->
                <div class="social-buttons-top">
                    <button type="button" class="social-btn google" onclick="handleGoogleSignIn()" title="Sign in with Google">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        <span>Google</span>
                    </button>
                    <button type="button" class="social-btn apple" onclick="handleAppleSignIn()" title="Sign in with Apple">
                        <span style="font-size: 20px;">üçé</span>
                        <span>Apple</span>
                    </button>
                </div>

                <div class="auth-divider-inline">or</div>

                <input type="email" class="auth-input" id="loginEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="auth-btn" id="loginBtn">Login</button>
                <a href="#" class="forgot-password-link" onclick="showResetPassword(event)">Forgot Password?</a>

                <div class="auth-tabs">
                    <button type="button" class="auth-tab" onclick="switchAuthTab('signup')">Need an account? Sign Up</button>
                </div>
            </form>

            <!-- Sign Up Form -->
            <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
                <!-- Social Sign In First -->
                <div class="social-buttons-top">
                    <button type="button" class="social-btn google" onclick="handleGoogleSignIn()" title="Sign in with Google">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        <span>Google</span>
                    </button>
                    <button type="button" class="social-btn apple" onclick="handleAppleSignIn()" title="Sign in with Apple">
                        <span style="font-size: 20px;">üçé</span>
                        <span>Apple</span>
                    </button>
                </div>

                <div class="auth-divider-inline">or</div>

                <input type="email" class="auth-input" id="signupEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="signupPassword" placeholder="Password (min 6 chars)" required minlength="6">
                <input type="password" class="auth-input" id="signupConfirmPassword" placeholder="Confirm Password" required minlength="6">
                <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>

                <div class="auth-tabs">
                    <button type="button" class="auth-tab" onclick="switchAuthTab('login')">Have an account? Login</button>
                </div>
            </form>

            <!-- Reset Password Form -->
            <form class="auth-form" id="resetForm" onsubmit="handleResetPassword(event)">
                <input type="email" class="auth-input" id="resetEmail" placeholder="Email" required>
                <button type="submit" class="auth-btn" id="resetBtn">Send Reset Link</button>
                <a href="#" class="forgot-password-link" onclick="switchAuthTab('login', event)">Back to Login</a>
            </form>
        </div>
    </div>

    <!-- Cookie Menu -->
    <div class="cookie-menu" id="cookieMenu">
        <button class="menu-share" onclick="shareEvent(); closeCookieMenu();">üîó Share with Friends</button>
        <button class="menu-clear" onclick="clearEverything(); closeCookieMenu();">üßπ Clear Everything</button>
        <button class="menu-logout" onclick="handleLogout()">üö™ Logout</button>
        <button class="menu-close" onclick="closeCookieMenu()">‚úñ Close</button>
    </div>

    <!-- Onboarding Modal for Shared Links -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-modal">
            <h2>üéâ Join the Carpool!</h2>
            <p id="onboardingEventName" class="onboarding-event-name"></p>

            <div id="onboardingStep1" class="onboarding-step">
                <p class="onboarding-question">Who are you?</p>
                <input type="text" id="onboardingName" class="onboarding-input" placeholder="Your name">
                <p class="onboarding-subtext">Logged in as: <span id="onboardingEmail"></span></p>

                <p class="onboarding-question">Are you driving or riding?</p>
                <div class="onboarding-buttons">
                    <button class="onboarding-btn driver-btn" onclick="selectRole('driver')">üöó I'm Driving</button>
                    <button class="onboarding-btn rider-btn" onclick="selectRole('rider')">üôã I'm Riding</button>
                </div>
            </div>

            <div id="onboardingStep2Driver" class="onboarding-step" style="display: none;">
                <p class="onboarding-question">Set up your car</p>
                <input type="number" id="onboardingSeats" class="onboarding-input" placeholder="How many seats?" min="1" max="20">
                <div class="emoji-picker-mini">
                    <span class="emoji-option" onclick="selectOnboardingEmoji('üöó')">üöó</span>
                    <span class="emoji-option" onclick="selectOnboardingEmoji('üöô')">üöô</span>
                    <span class="emoji-option" onclick="selectOnboardingEmoji('üöï')">üöï</span>
                    <span class="emoji-option" onclick="selectOnboardingEmoji('üöê')">üöê</span>
                    <span class="emoji-option" onclick="selectOnboardingEmoji('üõª')">üõª</span>
                </div>
                <input type="hidden" id="onboardingEmoji" value="üöô">
                <button class="onboarding-btn-primary" onclick="completeDriverOnboarding()">Add My Car</button>
            </div>

            <div id="onboardingStep2Rider" class="onboarding-step" style="display: none;">
                <p class="onboarding-question">Choose a car to join</p>
                <div id="onboardingCarList" class="onboarding-car-list"></div>
                <button class="onboarding-btn-secondary" onclick="skipRiderOnboarding()">I'll decide later</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="onboarding-overlay" id="shareModal">
        <div class="onboarding-modal" style="max-width: 400px;">
            <button class="close-modal" onclick="closeShareModal()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">√ó</button>
            <h2>üì¢ Share Event</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">How would you like to share?</p>

            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="shareViaText()" style="padding: 15px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üí¨ Send Text Message
                </button>

                <button onclick="shareViaNative()" style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üì± Share to App
                </button>

                <button onclick="copyShareLink()" style="padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üîó Copy Link
                </button>
            </div>

            <p style="color: #999; font-size: 12px; margin-top: 20px; text-align: center;">Anyone with the link can view and join</p>
        </div>
    </div>

    <div class="container">
        <h1>üöó Carpool Splitter üöô</h1>
        <p class="subtitle">Who's riding with who?! ü§™</p>

        <input type="text" id="eventName" class="event-input" placeholder="Event Name (e.g., Beach Trip!)">

        <!-- Event Details Section -->
        <div class="section event-details-section">
            <h2>üìã Event Details</h2>

            <div class="detail-group">
                <label>üìÖ Event Date</label>
                <input type="date" id="eventDate" class="detail-input">
            </div>

            <div class="detail-group">
                <label>üïê Event Time</label>
                <input type="time" id="eventTime" class="detail-input">
            </div>

            <div class="detail-group">
                <label>üìç Location</label>
                <input type="text" id="eventLocation" class="detail-input" placeholder="e.g., Mission Beach">
            </div>

            <div class="detail-group">
                <label>üó∫Ô∏è Address</label>
                <div class="address-group">
                    <input type="text" id="eventAddress" class="detail-input" placeholder="e.g., 123 Ocean Blvd, San Diego, CA">
                    <button type="button" class="maps-btn" onclick="openInMaps()">üìç Open in Maps</button>
                </div>
            </div>

            <div class="detail-group">
                <label>üìù Notes</label>
                <textarea id="eventNotes" class="detail-textarea" rows="3" placeholder="e.g., Bring towels, Parking is $20 cash, Leave by 8:15 sharp"></textarea>
            </div>

            <div class="detail-group">
                <label>üë• Max Attendees</label>
                <input type="number" id="maxAttendees" class="detail-input" placeholder="e.g., 20" min="1">
            </div>
        </div>

        <!-- Trip Costs Section -->
        <div class="section" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 2px solid #667eea;">
            <h2>üí∞ Trip Costs</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Split gas, parking, tolls fairly among passengers</p>

            <div class="detail-group">
                <label>‚õΩ Gas Cost (per car)</label>
                <input type="number" id="gasCost" class="detail-input" placeholder="e.g., 40" min="0" step="0.01" onchange="calculateCosts()">
            </div>

            <div class="detail-group">
                <label>üÖøÔ∏è Parking Fee (total)</label>
                <input type="number" id="parkingFee" class="detail-input" placeholder="e.g., 20" min="0" step="0.01" onchange="calculateCosts()">
            </div>

            <div class="detail-group">
                <label>üé´ Tolls / Entry Fees (total)</label>
                <input type="number" id="tollsFees" class="detail-input" placeholder="e.g., 15" min="0" step="0.01" onchange="calculateCosts()">
            </div>

            <div class="detail-group">
                <label>ü§ù Split Method</label>
                <select id="splitMethod" class="detail-input" onchange="calculateCosts()" style="cursor: pointer;">
                    <option value="passengers-only">Passengers split all costs (Drivers pay nothing)</option>
                    <option value="everyone">Everyone splits equally (including drivers)</option>
                    <option value="passengers-gas">Passengers split gas, Everyone splits parking/tolls</option>
                </select>
            </div>

            <div id="costSummary" style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; display: none;">
                <h3 style="margin: 0 0 10px 0; color: #667eea;">üíµ Cost Breakdown</h3>
                <div id="costBreakdownText"></div>
            </div>

            <button onclick="copyGroupChatSummary()" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                üìã Copy for Group Chat
            </button>
        </div>

        <div class="section">
            <h2>Add Car üöó</h2>
            <div class="input-group">
                <input type="text" id="driverName" placeholder="Driver's name">
                <input type="number" id="seatCount" placeholder="# of seats" min="1" max="20">
                <button onclick="addCar()">Add Car</button>
            </div>
        </div>

        <div class="section">
            <h2>Add Friend üë´</h2>
            <div class="input-group">
                <input type="text" id="passengerName" placeholder="Friend's nickname">
                <button onclick="addPassenger()">Add Friend</button>
            </div>

            <h3 style="margin-top: 20px; color: #ff6b6b;">Unassigned Friends:</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                <button class="auto-assign-btn" onclick="autoFillCars()" style="flex: 1; min-width: 150px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">‚ú® Auto-fill Cars</button>
                <button class="auto-assign-btn" onclick="randomizeCars()" style="flex: 1; min-width: 150px; padding: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üé≤ Randomize Cars</button>
            </div>
            <div class="unassigned-passengers" id="unassignedList"></div>
        </div>

        <div class="section">
            <h2>Carpool Lineup ‚úÖ</h2>
            <div class="cars-container" id="carsContainer"></div>
        </div>

        <button class="save-btn" onclick="saveData()">‚úÖ Auto Saved to Cloud</button>
    </div>

    <div class="dancing-cookie">üç™</div>

    <!-- TETRIS Letter Reveal -->
    <div class="tetris-reveal" id="tetrisReveal"></div>

    <!-- Game Boy Tetris Easter Egg -->
    <div class="gameboy-overlay" id="tetrisOverlay">
        <div class="gameboy">
            <button class="close-tetris" onclick="closeTetris()">√ó</button>
            <div class="gameboy-screen">
                <canvas id="tetrisCanvas" width="200" height="400" class="tetris-canvas"></canvas>
            </div>
            <div class="gameboy-info">
                <div>SCORE: <span id="tetrisScore">0</span></div>
                <div>LEVEL: <span id="tetrisLevel">1</span></div>
            </div>
            <div class="gameboy-controls">
                ‚Üê ‚Üí Move | ‚Üë Rotate | ‚Üì Drop<br>
                SPACE: Pause
            </div>
        </div>

        <!-- Mobile Touch Controls -->
        <div class="mobile-controls" id="mobileControls">
            <div class="control-row">
                <div class="control-btn" id="btnRotate">‚Üª</div>
            </div>
            <div class="control-row">
                <div class="control-btn" id="btnLeft">‚Üê</div>
                <div class="control-btn" id="btnDown">‚Üì</div>
                <div class="control-btn" id="btnRight">‚Üí</div>
            </div>
        </div>

        <!-- Music Prompt -->
        <div class="music-prompt" id="musicPrompt">üéµ Tap any button to start music!</div>
    </div>

    <!-- Hidden Audio Element for 8-bit MP3 -->
    <audio id="mp3Player" loop style="display:none;">
        <source src="the-return-of-the-8-bit-era-301292.mp3" type="audio/mpeg">
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB8x14SoITrwl0WAhRmAhWjNVEASKL3Gv8",
            authDomain: "carpooler-pro.firebaseapp.com",
            databaseURL: "https://carpooler-pro-default-rtdb.firebaseio.com",
            projectId: "carpooler-pro",
            storageBucket: "carpooler-pro.firebasestorage.app",
            messagingSenderId: "559447035458",
            appId: "1:559447035458:web:0ea044e624a560693ca7db",
            measurementId: "G-8NR3PQL6N7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Debug: Log Firebase initialization
        console.log('Firebase initialized:', {
            apiKey: firebaseConfig.apiKey.substring(0, 10) + '...',
            projectId: firebaseConfig.projectId,
            authDomain: firebaseConfig.authDomain
        });

        // ============================================
        // AUTHENTICATION SYSTEM
        // ============================================

        let currentUser = null;

        // Monitor authentication state
        auth.onAuthStateChanged((user) => {
            const cookie = document.querySelector('.dancing-cookie');
            if (user) {
                // User is signed in
                currentUser = user;
                console.log('User signed in:', user.email);

                // Hide auth modal
                document.getElementById('authOverlay').classList.remove('active');

                // Show cookie again
                if (cookie) cookie.classList.remove('hidden');

                // Initialize app with user's data
                initializeUserData();
            } else {
                // No user signed in - show auth modal
                currentUser = null;
                console.log('No user signed in');

                document.getElementById('authOverlay').classList.add('active');

                // Hide cookie while auth modal is showing
                if (cookie) cookie.classList.add('hidden');
            }
        });

        // Switch between login and signup tabs
        function switchAuthTab(tab, event) {
            if (event) event.preventDefault();

            const loginTab = document.querySelector('.auth-tab:nth-child(1)');
            const signupTab = document.querySelector('.auth-tab:nth-child(2)');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const resetForm = document.getElementById('resetForm');
            const authError = document.getElementById('authError');

            // Clear error
            authError.classList.remove('show');

            // Hide all forms first
            loginForm.classList.remove('active');
            signupForm.classList.remove('active');
            resetForm.classList.remove('active');

            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.classList.add('active');
            } else if (tab === 'signup') {
                signupTab.classList.add('active');
                loginTab.classList.remove('active');
                signupForm.classList.add('active');
            } else if (tab === 'reset') {
                loginTab.classList.remove('active');
                signupTab.classList.remove('active');
                resetForm.classList.add('active');
            }
        }

        // Show reset password form
        function showResetPassword(event) {
            event.preventDefault();
            switchAuthTab('reset');
        }

        // Show error message
        function showAuthError(message) {
            const authError = document.getElementById('authError');
            authError.textContent = message;
            authError.classList.add('show');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            console.log('Attempting login for:', email);

            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                console.log('Login successful:', result.user.email);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                let errorMessage = 'Login failed. Please try again.';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Try again later.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password.';
                } else {
                    errorMessage = `Login failed: ${error.message}`;
                }

                showAuthError(errorMessage);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        // Handle signup
        async function handleSignup(event) {
            event.preventDefault();

            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const signupBtn = document.getElementById('signupBtn');

            console.log('Attempting signup for:', email);

            // Validate passwords match
            if (password !== confirmPassword) {
                showAuthError('Passwords do not match!');
                return;
            }

            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';

            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                console.log('Signup successful:', result.user.email);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Signup error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                let errorMessage = 'Signup failed. Please try again.';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Try logging in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                } else {
                    errorMessage = `Signup failed: ${error.message}`;
                }

                showAuthError(errorMessage);
            } finally {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        }

        // Handle password reset
        async function handleResetPassword(event) {
            event.preventDefault();

            const email = document.getElementById('resetEmail').value;
            const resetBtn = document.getElementById('resetBtn');

            resetBtn.disabled = true;
            resetBtn.textContent = 'Sending...';

            try {
                await auth.sendPasswordResetEmail(email);
                alert('Password reset email sent! Check your inbox.');
                switchAuthTab('login');
                document.getElementById('resetEmail').value = '';
            } catch (error) {
                console.error('Password reset error:', error);
                let errorMessage = 'Failed to send reset email. Please try again.';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                }

                showAuthError(errorMessage);
            } finally {
                resetBtn.disabled = false;
                resetBtn.textContent = 'Send Reset Link';
            }
        }

        // Handle Google Sign In
        async function handleGoogleSignIn() {
            console.log('Attempting Google sign in...');
            const provider = new firebase.auth.GoogleAuthProvider();

            try {
                const result = await auth.signInWithPopup(provider);
                console.log('Google sign in successful:', result.user.email);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Google sign in error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                let errorMessage = 'Google sign in failed. Please try again.';

                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign in cancelled.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Pop-up blocked. Please allow pop-ups and try again.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'This domain is not authorized. Please check Firebase settings.';
                } else {
                    errorMessage = `Google sign in failed: ${error.message}`;
                }

                showAuthError(errorMessage);
            }
        }

        // Handle Apple Sign In
        async function handleAppleSignIn() {
            console.log('Attempting Apple sign in...');
            const provider = new firebase.auth.OAuthProvider('apple.com');

            try {
                const result = await auth.signInWithPopup(provider);
                console.log('Apple sign in successful:', result.user.email);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Apple sign in error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                let errorMessage = 'Apple sign in failed. Please try again.';

                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign in cancelled.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Pop-up blocked. Please allow pop-ups and try again.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'This domain is not authorized. Please check Firebase settings.';
                } else {
                    errorMessage = `Apple sign in failed: ${error.message}`;
                }

                showAuthError(errorMessage);
            }
        }

        // Handle logout
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    // onAuthStateChanged will handle showing the auth modal
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed. Please try again.');
                }
            }
        }

        // Initialize user's data after authentication
        function initializeUserData() {
            // This will be called after user signs in
            // Set up the database reference with user-specific path
            eventId = getOrCreateEventId();
            dbRef = database.ref(`users/${currentUser.uid}/events/${eventId}`);
            loadData();
        }

        // ============================================
        // END AUTHENTICATION SYSTEM
        // ============================================

        // Get or create event ID from URL parameter
        let eventId = null;
        let dbRef = null;

        function getOrCreateEventId() {
            const params = new URLSearchParams(window.location.search);
            const urlEventId = params.get('e');

            if (urlEventId) {
                // Joining specific event from URL
                console.log('Joining event:', urlEventId);
                return urlEventId;
            } else {
                // Use default shared event - everyone accessing base URL sees same data
                console.log('Using default shared event');
                return 'default';
            }
        }

        // Don't initialize dbRef here - wait for authentication
        // eventId and dbRef will be set in initializeUserData() after sign-in
        eventId = null;
        dbRef = null;

        let cars = [];
        let unassignedPassengers = [];
        let selectedEmoji = 'üöô';
        let isSaving = false;

        // Security: Rate limiting to prevent spam
        let lastActionTime = 0;
        const ACTION_COOLDOWN = 500; // 500ms between actions

        function isRateLimited() {
            const now = Date.now();
            if (now - lastActionTime < ACTION_COOLDOWN) {
                alert('Slow down! You\'re going too fast üêå');
                return true;
            }
            lastActionTime = now;
            return false;
        }

        // Security: Sanitize user input to prevent XSS attacks
        function sanitizeInput(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Security: Validate input length and content
        function validateInput(input, maxLength, fieldName) {
            if (!input || input.trim().length === 0) {
                alert(`Please enter a ${fieldName}!`);
                return false;
            }
            if (input.length > maxLength) {
                alert(`${fieldName} must be ${maxLength} characters or less!`);
                return false;
            }
            // Block obviously malicious patterns
            if (/<script|javascript:|onerror|onclick/i.test(input)) {
                alert('Invalid characters detected!');
                return false;
            }
            return true;
        }

        // Auto-save function - now saves to Firebase!
        function autoSave() {
            if (isSaving) return; // Don't save if already saving

            // Check if user is authenticated and dbRef is initialized
            if (!currentUser || !dbRef) {
                console.log('Cannot save: User not authenticated or dbRef not initialized');
                return;
            }

            isSaving = true;

            const eventName = document.getElementById('eventName').value.trim();

            // Security: Sanitize and limit event name length
            const sanitizedEventName = eventName.length > 100
                ? sanitizeInput(eventName.substring(0, 100))
                : sanitizeInput(eventName);

            // Get event details
            const eventDetails = {
                date: document.getElementById('eventDate').value || '',
                time: document.getElementById('eventTime').value || '',
                location: sanitizeInput(document.getElementById('eventLocation').value.trim()),
                address: sanitizeInput(document.getElementById('eventAddress').value.trim()),
                notes: sanitizeInput(document.getElementById('eventNotes').value.trim()),
                maxAttendees: document.getElementById('maxAttendees').value || '',
                gasCost: document.getElementById('gasCost').value || '',
                parkingFee: document.getElementById('parkingFee').value || '',
                tollsFees: document.getElementById('tollsFees').value || '',
                splitMethod: document.getElementById('splitMethod').value || 'passengers-only'
            };

            // Use transactions to update specific fields atomically
            // This prevents overwriting teammates' concurrent edits
            const updates = {};
            updates[`users/${currentUser.uid}/events/${eventId}/eventName`] = sanitizedEventName;
            updates[`users/${currentUser.uid}/events/${eventId}/eventDetails`] = eventDetails;
            updates[`users/${currentUser.uid}/events/${eventId}/cars`] = cars;
            updates[`users/${currentUser.uid}/events/${eventId}/unassignedPassengers`] = unassignedPassengers;
            updates[`users/${currentUser.uid}/events/${eventId}/lastUpdated`] = firebase.database.ServerValue.TIMESTAMP;

            // Use update() instead of set() to avoid overwriting entire object
            database.ref().update(updates).then(() => {
                console.log('Saved to Firebase!');
                setTimeout(() => {
                    isSaving = false;
                }, 500);
            }).catch(error => {
                console.error('Error saving to Firebase:', error);
                alert('Save Error: ' + error.message + '\n\nCheck that:\n1. Firebase Realtime Database is enabled\n2. Security rules are published\n3. You have internet connection\n\nError details: ' + error.code);
                isSaving = false;
            });
        }

        // Open address in Maps
        function openInMaps() {
            const address = document.getElementById('eventAddress').value.trim();
            if (!address) {
                alert('Please enter an address first!');
                return;
            }

            // Create Google Maps URL
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
            window.open(mapsUrl, '_blank');
        }

        function addCar() {
            // Security: Rate limiting
            if (isRateLimited()) return;

            const driverName = document.getElementById('driverName').value.trim();
            const seatCount = parseInt(document.getElementById('seatCount').value);

            // Security: Validate driver name
            if (!validateInput(driverName, 50, 'driver name')) {
                return;
            }

            // Validate seat count
            if (!seatCount || seatCount < 1 || seatCount > 20) {
                alert('Please enter a valid seat count (1-20)!');
                return;
            }

            // Security: Sanitize driver name before storing
            const sanitizedName = sanitizeInput(driverName);

            cars.push({
                id: Date.now(),
                driver: sanitizedName,
                seats: seatCount,
                passengers: [],
                emoji: selectedEmoji
            });

            document.getElementById('driverName').value = '';
            document.getElementById('seatCount').value = '';

            renderCars();
            autoSave();
        }

        function addPassenger() {
            // Security: Rate limiting
            if (isRateLimited()) return;

            const passengerName = document.getElementById('passengerName').value.trim();

            // Security: Validate friend name
            if (!validateInput(passengerName, 50, 'friend name')) {
                return;
            }

            // Security: Sanitize friend name before storing
            const sanitizedName = sanitizeInput(passengerName);

            unassignedPassengers.push({
                id: Date.now(),
                name: sanitizedName
            });

            document.getElementById('passengerName').value = '';
            renderUnassigned();
            autoSave();
        }

        function assignPassenger(passengerId, carId) {
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            const car = cars.find(c => c.id === carId);

            if (!passenger || !car) return;

            if (car.passengers.length >= car.seats) {
                alert('This car is full!');
                return;
            }

            car.passengers.push(passenger);
            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);

            renderCars();
            renderUnassigned();
            autoSave();
        }

        function removePassengerFromCar(carId, passengerId) {
            const car = cars.find(c => c.id === carId);
            const passenger = car.passengers.find(p => p.id === passengerId);

            if (!passenger) return;

            car.passengers = car.passengers.filter(p => p.id !== passengerId);
            unassignedPassengers.push(passenger);

            renderCars();
            renderUnassigned();
            autoSave();
        }

        function deleteCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (car) {
                unassignedPassengers.push(...car.passengers);
            }
            cars = cars.filter(c => c.id !== carId);
            renderCars();
            renderUnassigned();
            autoSave();
        }

        function editSeats(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;

            const newSeats = prompt(`Change number of seats for ${car.driver}'s car:`, car.seats);
            if (newSeats === null) return; // User cancelled

            const seatCount = parseInt(newSeats);
            if (isNaN(seatCount) || seatCount < 1) {
                alert('Please enter a valid number of seats!');
                return;
            }

            if (seatCount < car.passengers.length) {
                alert(`Cannot set seats to ${seatCount} because there are already ${car.passengers.length} friends in this car!`);
                return;
            }

            car.seats = seatCount;
            renderCars();
            autoSave();
        }

        function renderCars() {
            const container = document.getElementById('carsContainer');

            if (cars.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No cars yet! Add one above.</p>';
                return;
            }

            container.innerHTML = cars.map(car => {
                // Ensure passengers array exists
                if (!car.passengers) {
                    car.passengers = [];
                }
                const isFull = car.passengers.length >= car.seats;

                // Permission checks
                const isEventOwner = currentShareId && eventOwnerId && currentUser && currentUser.uid === eventOwnerId;
                const isCarOwner = currentUser && car.ownerId && currentUser.uid === car.ownerId;
                const canEditCar = !currentShareId || isEventOwner || isCarOwner;
                const canDeleteCar = !currentShareId || isEventOwner || isCarOwner;

                return `
                    <div class="car-card ${isFull ? 'full' : ''}" onclick="handleCarClick(event, ${car.id})">
                        ${canDeleteCar ? `<button class="delete-car" onclick="event.stopPropagation(); deleteCar(${car.id})">√ó</button>` : ''}
                        <div class="car-visual">${car.emoji}</div>
                        <div class="car-info">
                            Driver: ${car.driver}${isCarOwner ? ' <span style="color: #4CAF50; font-size: 0.8em;">(You)</span>' : ''}
                        </div>
                        <div class="seats-info">
                            ${car.passengers.length} / ${canEditCar ? `<span class="editable-seats" onclick="event.stopPropagation(); editSeats(${car.id})">${car.seats}</span>` : car.seats} seats filled ${isFull ? '<span style="color: #f44336; font-weight: bold;">(FULL!)</span>' : ''}
                        </div>
                        <div class="passengers-list">
                            ${car.passengers.map(p => {
                                const isThisUser = currentUser && p.userId && currentUser.uid === p.userId;
                                const canRemovePassenger = !currentShareId || isEventOwner || isCarOwner || isThisUser;
                                return `
                                    <div class="passenger-tag" ${canRemovePassenger ? `onclick="event.stopPropagation(); removePassengerFromCar(${car.id}, ${p.id})"` : ''}>
                                        ${p.name}${isThisUser ? ' <span style="color: #4CAF50;">(You)</span>' : ''}
                                        ${canRemovePassenger ? '<span class="remove">√ó</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${car.perPassengerCost && car.perPassengerCost > 0 && car.passengers.length > 0 ? `
                            <div style="margin-top: 12px; padding: 10px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 6px; border-left: 3px solid #667eea;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">üí∞ Cost per passenger:</div>
                                <div style="font-size: 18px; font-weight: bold; color: #667eea;">$${car.perPassengerCost.toFixed(2)}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">Driver gets: <strong style="color: #4CAF50;">$${car.totalCarCost.toFixed(2)}</strong></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function removeUnassignedFriend(passengerId) {
            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);
            renderUnassigned();
            autoSave();
        }

        function renderUnassigned() {
            const container = document.getElementById('unassignedList');

            if (unassignedPassengers.length === 0) {
                container.innerHTML = '<p style="color: #999;">All friends are assigned!</p>';
                return;
            }

            container.innerHTML = unassignedPassengers.map(p => `
                <div class="unassigned-tag" data-passenger-id="${p.id}">
                    ${p.name}
                    <span class="remove" onclick="event.stopPropagation(); removeUnassignedFriend(${p.id})">√ó</span>
                </div>
            `).join('');

            // Add click handlers for drag-to-assign
            container.querySelectorAll('.unassigned-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const passengerId = parseInt(this.dataset.passengerId);
                    selectPassengerForAssignment(passengerId);
                });
            });
        }

        let selectedPassengerId = null;

        function selectPassengerForAssignment(passengerId) {
            selectedPassengerId = passengerId;
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            alert(`Click on a car to assign ${passenger.name}! üöó`);
        }

        function handleCarClick(event, carId) {
            if (selectedPassengerId) {
                assignPassenger(selectedPassengerId, carId);
                selectedPassengerId = null;
            }
        }

        // Manual save function (auto-save happens automatically in background)
        function saveData() {
            autoSave();
            alert('Saved to cloud! ‚òÅÔ∏è');
        }

        // Clear everything function
        function clearEverything() {
            if (confirm('Going to clear everything now.')) {
                // Clear local data
                cars = [];
                unassignedPassengers = [];
                document.getElementById('eventName').value = '';

                // Clear event details
                document.getElementById('eventDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('eventLocation').value = '';
                document.getElementById('eventAddress').value = '';
                document.getElementById('eventNotes').value = '';
                document.getElementById('maxAttendees').value = '';

                // Clear Firebase
                dbRef.remove().then(() => {
                    console.log('Firebase data cleared');
                }).catch(error => {
                    console.error('Error clearing Firebase:', error);
                });

                // Re-render
                renderCars();
                renderUnassigned();

                alert('Everything cleared! üßπ');
            }
        }

        // Share data (global for modal access)
        let currentShareUrl = '';
        let currentShareSummary = '';

        // Share event with friends
        async function shareEvent() {
            if (!currentUser) {
                alert('You must be logged in to share events!');
                return;
            }

            const eventName = document.getElementById('eventName').value.trim();
            if (!eventName) {
                alert('Please add an event name before sharing!');
                return;
            }

            if (cars.length === 0 && unassignedPassengers.length === 0) {
                alert('Please add some cars or friends before sharing!');
                return;
            }

            try {
                // Generate unique share ID
                const shareId = generateShareId();

                // Get event details
                const eventDetails = {
                    date: document.getElementById('eventDate').value || '',
                    time: document.getElementById('eventTime').value || '',
                    location: sanitizeInput(document.getElementById('eventLocation').value.trim()),
                    address: sanitizeInput(document.getElementById('eventAddress').value.trim()),
                    notes: sanitizeInput(document.getElementById('eventNotes').value.trim()),
                    maxAttendees: document.getElementById('maxAttendees').value || ''
                };

                // Save event to shared location
                const sharedData = {
                    ownerId: currentUser.uid,
                    ownerEmail: currentUser.email,
                    eventName: sanitizeInput(eventName),
                    eventDetails: eventDetails,
                    cars: cars,
                    unassignedPassengers: unassignedPassengers,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref(`shared/${shareId}`).set(sharedData);

                // Generate share URL
                currentShareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;

                // Create event summary for sharing
                currentShareSummary = `üì¢ ${eventName}`;

                if (eventDetails.date && eventDetails.time) {
                    const dateObj = new Date(eventDetails.date + 'T' + eventDetails.time);
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    currentShareSummary += `\nüìÖ ${dateStr} at ${timeStr}`;
                } else if (eventDetails.date) {
                    const dateObj = new Date(eventDetails.date);
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    currentShareSummary += `\nüìÖ ${dateStr}`;
                }

                if (eventDetails.location) {
                    currentShareSummary += `\nüìç ${eventDetails.location}`;
                }

                if (eventDetails.notes) {
                    currentShareSummary += `\nüìù ${eventDetails.notes}`;
                }

                currentShareSummary += `\n\nüîó ${currentShareUrl}\n\nAnyone with this link can view and join this carpool!`;

                // Open share modal
                document.getElementById('shareModal').classList.add('active');

            } catch (error) {
                console.error('Share error:', error);
                alert('Failed to create share link. Please try again.');
            }
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        async function copyShareLink() {
            try {
                await navigator.clipboard.writeText(currentShareUrl);
                alert('Share link copied to clipboard! üìã');
                closeShareModal();
            } catch (error) {
                prompt('Copy this link:', currentShareUrl);
            }
        }

        function shareViaText() {
            // SMS sharing - works on iOS and Android
            const smsBody = encodeURIComponent(currentShareSummary);
            window.location.href = `sms:?&body=${smsBody}`;
            closeShareModal();
        }

        async function shareViaNative() {
            // Try native share API (works on mobile and some desktop browsers)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Join my carpool!',
                        text: currentShareSummary,
                        url: currentShareUrl
                    });
                    closeShareModal();
                } catch (error) {
                    // User cancelled or error occurred
                    if (error.name !== 'AbortError') {
                        console.error('Share error:', error);
                        // Fall back to copy
                        copyShareLink();
                    }
                }
            } else {
                alert('Native sharing not supported. Copying link instead!');
                copyShareLink();
            }
        }

        // ============================================
        // AUTO-ASSIGN FEATURES
        // ============================================

        function autoFillCars() {
            if (unassignedPassengers.length === 0) {
                alert('No unassigned friends to auto-fill! ü§∑');
                return;
            }

            if (cars.length === 0) {
                alert('Please add at least one car first! üöó');
                return;
            }

            // Calculate available seats in each car
            const availableSeats = cars.map((car, index) => ({
                carIndex: index,
                available: car.seats - car.passengers.length
            })).filter(car => car.available > 0);

            if (availableSeats.length === 0) {
                alert('All cars are full! Add more cars or increase seat counts. üöô');
                return;
            }

            // Total available seats
            const totalAvailable = availableSeats.reduce((sum, car) => sum + car.available, 0);

            if (unassignedPassengers.length > totalAvailable) {
                if (!confirm(`Only ${totalAvailable} seats available, but ${unassignedPassengers.length} friends unassigned. Fill as many as possible?`)) {
                    return;
                }
            }

            // Fill cars evenly
            let passengersToAssign = [...unassignedPassengers];
            let carPointer = 0;

            while (passengersToAssign.length > 0 && availableSeats.length > 0) {
                const currentCar = availableSeats[carPointer];

                if (currentCar.available > 0) {
                    // Assign passenger to car
                    const passenger = passengersToAssign.shift();
                    cars[currentCar.carIndex].passengers.push(passenger);
                    currentCar.available--;
                }

                // Move to next car (circular)
                carPointer = (carPointer + 1) % availableSeats.length;

                // Remove cars that are now full
                availableSeats.forEach((car, index) => {
                    if (car.available <= 0) {
                        availableSeats.splice(index, 1);
                        if (carPointer >= availableSeats.length) {
                            carPointer = 0;
                        }
                    }
                });
            }

            // Update unassigned list
            unassignedPassengers = passengersToAssign;

            renderCars();
            renderUnassigned();
            autoSave();

            const assigned = unassignedPassengers.length === 0
                ? 'All friends assigned! ‚ú®'
                : `Assigned friends to available seats! ${unassignedPassengers.length} still unassigned.`;
            alert(assigned);
        }

        function randomizeCars() {
            if (cars.length === 0) {
                alert('Please add at least one car first! üöó');
                return;
            }

            // Collect all passengers from all cars
            let allPassengers = [];
            cars.forEach(car => {
                allPassengers = allPassengers.concat(car.passengers);
            });

            // Add unassigned passengers
            allPassengers = allPassengers.concat(unassignedPassengers);

            if (allPassengers.length === 0) {
                alert('No passengers to randomize! üë•');
                return;
            }

            if (!confirm('üé≤ Shuffle all passengers randomly across cars? (Drivers stay fixed)')) {
                return;
            }

            // Shuffle passengers
            for (let i = allPassengers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allPassengers[i], allPassengers[j]] = [allPassengers[j], allPassengers[i]];
            }

            // Clear all cars
            cars.forEach(car => {
                car.passengers = [];
            });

            // Reassign passengers
            let passengerIndex = 0;
            let carIndex = 0;

            while (passengerIndex < allPassengers.length) {
                const car = cars[carIndex];

                if (car.passengers.length < car.seats) {
                    car.passengers.push(allPassengers[passengerIndex]);
                    passengerIndex++;
                } else {
                    carIndex++;
                    if (carIndex >= cars.length) {
                        // No more space in any car
                        break;
                    }
                }
            }

            // Any remaining passengers go to unassigned
            unassignedPassengers = allPassengers.slice(passengerIndex);

            renderCars();
            renderUnassigned();
            autoSave();

            alert('üé≤ Passengers randomized! Drivers stayed in their cars. ‚ú®');
        }

        // ============================================
        // COST SPLITTING FEATURES
        // ============================================

        function calculateCosts() {
            const gasCost = parseFloat(document.getElementById('gasCost').value) || 0;
            const parkingFee = parseFloat(document.getElementById('parkingFee').value) || 0;
            const tollsFees = parseFloat(document.getElementById('tollsFees').value) || 0;
            const splitMethod = document.getElementById('splitMethod').value;

            // No costs entered
            if (gasCost === 0 && parkingFee === 0 && tollsFees === 0) {
                document.getElementById('costSummary').style.display = 'none';
                renderCars();
                return;
            }

            // Count total people
            let totalPassengers = 0;
            let totalPeople = cars.length; // Start with drivers

            cars.forEach(car => {
                totalPassengers += car.passengers.length;
                totalPeople += car.passengers.length;
            });

            if (totalPeople === 0) {
                document.getElementById('costSummary').style.display = 'none';
                return;
            }

            const totalCosts = (gasCost * cars.length) + parkingFee + tollsFees;
            let breakdownHTML = '';

            // Calculate per-car costs
            cars.forEach((car, index) => {
                let carCost = 0;
                let perPassengerCost = 0;

                if (splitMethod === 'passengers-only') {
                    // Passengers split everything
                    if (totalPassengers > 0) {
                        perPassengerCost = totalCosts / totalPassengers;
                        carCost = perPassengerCost * car.passengers.length;
                    }
                } else if (splitMethod === 'everyone') {
                    // Everyone splits equally
                    perPassengerCost = totalCosts / totalPeople;
                    carCost = perPassengerCost * (car.passengers.length + 1); // +1 for driver
                } else if (splitMethod === 'passengers-gas') {
                    // Passengers split gas, everyone splits parking/tolls
                    const sharedCosts = parkingFee + tollsFees;
                    const sharedPerPerson = sharedCosts / totalPeople;

                    if (totalPassengers > 0) {
                        const gasPerPassenger = (gasCost * cars.length) / totalPassengers;
                        perPassengerCost = gasPerPassenger + sharedPerPerson;
                        const driverShareOfShared = sharedPerPerson;
                        carCost = (perPassengerCost * car.passengers.length);
                    } else {
                        perPassengerCost = sharedPerPerson;
                        carCost = sharedPerPerson * (car.passengers.length + 1);
                    }
                }

                // Store costs on car object for rendering
                car.perPassengerCost = perPassengerCost;
                car.totalCarCost = carCost;
            });

            // Generate breakdown text
            breakdownHTML += `<div style="color: #666; line-height: 1.8;">`;
            breakdownHTML += `<strong>Total Trip Cost:</strong> $${totalCosts.toFixed(2)}<br>`;
            breakdownHTML += `<strong>Split Method:</strong> ${getSplitMethodText(splitMethod)}<br><br>`;

            cars.forEach((car, index) => {
                if (car.passengers.length > 0) {
                    breakdownHTML += `<div style="margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px;">`;
                    breakdownHTML += `<strong>${car.emoji} ${car.driver}'s car:</strong><br>`;
                    breakdownHTML += `Each passenger pays: <strong style="color: #667eea;">$${car.perPassengerCost.toFixed(2)}</strong><br>`;
                    breakdownHTML += `Driver receives: <strong style="color: #4CAF50;">$${car.totalCarCost.toFixed(2)}</strong>`;
                    breakdownHTML += `</div>`;
                }
            });

            breakdownHTML += `</div>`;

            document.getElementById('costBreakdownText').innerHTML = breakdownHTML;
            document.getElementById('costSummary').style.display = 'block';

            // Re-render cars to show costs
            renderCars();
            autoSave();
        }

        function getSplitMethodText(method) {
            if (method === 'passengers-only') return 'Passengers split all costs (Drivers pay nothing)';
            if (method === 'everyone') return 'Everyone splits equally';
            if (method === 'passengers-gas') return 'Passengers split gas, Everyone splits parking/tolls';
            return method;
        }

        function copyGroupChatSummary() {
            const eventName = document.getElementById('eventName').value.trim() || 'Carpool';

            if (cars.length === 0) {
                alert('Add some cars first! üöó');
                return;
            }

            let summary = `üöó ${eventName} - Carpool Assignments\n\n`;

            // Event details if available
            const eventDate = document.getElementById('eventDate').value;
            const eventTime = document.getElementById('eventTime').value;
            const eventLocation = document.getElementById('eventLocation').value;

            if (eventDate && eventTime) {
                const dateObj = new Date(eventDate + 'T' + eventTime);
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                summary += `üìÖ ${dateStr} at ${timeStr}\n`;
            }

            if (eventLocation) {
                summary += `üìç ${eventLocation}\n`;
            }

            if (eventDate || eventLocation) {
                summary += `\n`;
            }

            // Car assignments
            cars.forEach((car, index) => {
                summary += `${car.emoji} ${car.driver}'s car (${car.passengers.length}/${car.seats} seats):\n`;

                if (car.passengers.length > 0) {
                    const passengerNames = car.passengers.map(p => p.name).join(', ');
                    summary += `   Passengers: ${passengerNames}\n`;

                    // Add cost info if costs are set
                    if (car.perPassengerCost && car.perPassengerCost > 0) {
                        summary += `   üí∞ Each passenger: $${car.perPassengerCost.toFixed(2)}\n`;
                    }
                } else {
                    summary += `   (Empty - need passengers!)\n`;
                }

                summary += `\n`;
            });

            // Unassigned passengers
            if (unassignedPassengers.length > 0) {
                summary += `‚ö†Ô∏è Unassigned: ${unassignedPassengers.map(p => p.name).join(', ')}\n\n`;
            }

            // Cost summary
            const gasCost = parseFloat(document.getElementById('gasCost').value) || 0;
            const parkingFee = parseFloat(document.getElementById('parkingFee').value) || 0;
            const tollsFees = parseFloat(document.getElementById('tollsFees').value) || 0;

            if (gasCost > 0 || parkingFee > 0 || tollsFees > 0) {
                summary += `üíµ Total Trip Cost: $${((gasCost * cars.length) + parkingFee + tollsFees).toFixed(2)}\n`;
                summary += `   ‚õΩ Gas: $${gasCost}/car | üÖøÔ∏è Parking: $${parkingFee} | üé´ Tolls: $${tollsFees}\n`;
            }

            // Copy to clipboard
            try {
                navigator.clipboard.writeText(summary).then(() => {
                    alert('üìã Copied to clipboard! Paste into your group chat.');
                }).catch(err => {
                    prompt('Copy this text:', summary);
                });
            } catch (error) {
                prompt('Copy this text:', summary);
            }
        }

        // Generate random share ID
        function generateShareId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            for (let i = 0; i < 8; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return id;
        }

        // ============================================
        // ONBOARDING SYSTEM FOR SHARED EVENTS
        // ============================================

        let currentShareId = null;
        let eventOwnerId = null;
        let selectedOnboardingEmoji = 'üöô';

        function selectRole(role) {
            document.getElementById('onboardingStep1').style.display = 'none';

            if (role === 'driver') {
                document.getElementById('onboardingStep2Driver').style.display = 'block';
            } else {
                document.getElementById('onboardingStep2Rider').style.display = 'block';
                renderOnboardingCarList();
            }
        }

        function selectOnboardingEmoji(emoji) {
            selectedOnboardingEmoji = emoji;
            document.getElementById('onboardingEmoji').value = emoji;

            // Update visual selection
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function completeDriverOnboarding() {
            const name = document.getElementById('onboardingName').value.trim();
            const seats = parseInt(document.getElementById('onboardingSeats').value);

            if (!name) {
                alert('Please enter your name!');
                return;
            }

            if (!seats || seats < 1 || seats > 20) {
                alert('Please enter valid number of seats (1-20)!');
                return;
            }

            // Add car with user's UID
            const newCar = {
                driver: name,
                seats: seats,
                emoji: selectedOnboardingEmoji,
                passengers: [],
                ownerId: currentUser.uid,
                ownerEmail: currentUser.email
            };

            cars.push(newCar);
            autoSave();

            // Close onboarding
            document.getElementById('onboardingOverlay').classList.remove('active');
            alert(`üéâ Your car has been added! You're driving with ${seats} seats available.`);
        }

        function renderOnboardingCarList() {
            const carList = document.getElementById('onboardingCarList');
            carList.innerHTML = '';

            if (cars.length === 0) {
                carList.innerHTML = '<p style="text-align: center; color: #666;">No cars yet. Be the first driver!</p>';
                return;
            }

            cars.forEach((car, index) => {
                const availableSeats = car.seats - car.passengers.length;
                const isFull = availableSeats <= 0;

                const cardHTML = `
                    <div class="onboarding-car-card">
                        <div class="onboarding-car-info">
                            <div class="onboarding-car-driver">${car.emoji} ${car.driver}</div>
                            <div class="onboarding-car-seats">${availableSeats} of ${car.seats} seats available</div>
                        </div>
                        <button class="onboarding-join-btn"
                                onclick="joinCarFromOnboarding(${index})"
                                ${isFull ? 'disabled' : ''}>
                            ${isFull ? 'FULL' : 'Join'}
                        </button>
                    </div>
                `;
                carList.innerHTML += cardHTML;
            });
        }

        function joinCarFromOnboarding(carIndex) {
            const name = document.getElementById('onboardingName').value.trim();

            if (!name) {
                alert('Please enter your name!');
                return;
            }

            // Add passenger with user's UID
            const passenger = {
                name: name,
                userId: currentUser.uid,
                userEmail: currentUser.email
            };

            cars[carIndex].passengers.push(passenger);
            autoSave();

            // Close onboarding
            document.getElementById('onboardingOverlay').classList.remove('active');
            alert(`üéâ You've joined ${cars[carIndex].driver}'s car!`);
        }

        function skipRiderOnboarding() {
            document.getElementById('onboardingOverlay').classList.remove('active');
        }

        function showOnboardingModal(eventName) {
            // Check if user already has a spot
            let userHasSpot = false;

            cars.forEach(car => {
                if (car.ownerId === currentUser.uid) {
                    userHasSpot = true;
                }
                if (car.passengers && car.passengers.some(p => p.userId === currentUser.uid)) {
                    userHasSpot = true;
                }
            });

            if (unassignedPassengers && unassignedPassengers.some(p => p.userId === currentUser.uid)) {
                userHasSpot = true;
            }

            // Only show onboarding if user doesn't have a spot
            if (!userHasSpot) {
                document.getElementById('onboardingEventName').textContent = eventName || 'this event';
                document.getElementById('onboardingName').value = currentUser.displayName || currentUser.email.split('@')[0];
                document.getElementById('onboardingEmail').textContent = currentUser.email;
                document.getElementById('onboardingOverlay').classList.add('active');
            }
        }

        // Check if user is accessing a shared event
        function checkForSharedEvent() {
            const params = new URLSearchParams(window.location.search);
            const shareId = params.get('share');

            if (shareId) {
                currentShareId = shareId;
                console.log('Loading shared event:', shareId);

                // Load shared event data
                database.ref(`shared/${shareId}`).on('value', (snapshot) => {
                    const data = snapshot.val();

                    if (!data) {
                        alert('This shared event does not exist or has been deleted.');
                        return;
                    }

                    // Load shared event into app
                    document.getElementById('eventName').value = data.eventName || '';

                    // Load event details
                    if (data.eventDetails) {
                        document.getElementById('eventDate').value = data.eventDetails.date || '';
                        document.getElementById('eventTime').value = data.eventDetails.time || '';
                        document.getElementById('eventLocation').value = data.eventDetails.location || '';
                        document.getElementById('eventAddress').value = data.eventDetails.address || '';
                        document.getElementById('eventNotes').value = data.eventDetails.notes || '';
                        document.getElementById('maxAttendees').value = data.eventDetails.maxAttendees || '';
                        document.getElementById('gasCost').value = data.eventDetails.gasCost || '';
                        document.getElementById('parkingFee').value = data.eventDetails.parkingFee || '';
                        document.getElementById('tollsFees').value = data.eventDetails.tollsFees || '';
                        document.getElementById('splitMethod').value = data.eventDetails.splitMethod || 'passengers-only';
                    }

                    cars = data.cars || [];
                    unassignedPassengers = data.unassignedPassengers || [];
                    eventOwnerId = data.ownerId || null;

                    // Ensure all cars have passengers arrays
                    cars.forEach(car => {
                        if (!car.passengers) {
                            car.passengers = [];
                        }
                    });

                    renderCars();
                    renderUnassigned();
                    calculateCosts(); // Calculate costs after loading shared data

                    // Show onboarding modal if user is new to this event
                    if (currentUser) {
                        showOnboardingModal(data.eventName);
                    }

                    // Show sharing info
                    const ownerInfo = data.ownerEmail ? ` (shared by ${data.ownerEmail})` : '';
                    console.log(`Loaded shared event${ownerInfo}`);
                });

                // Override save function to save to shared location
                const originalAutoSave = autoSave;
                autoSave = function() {
                    if (isSaving) return;
                    isSaving = true;

                    const eventName = document.getElementById('eventName').value.trim();
                    const sanitizedEventName = eventName.length > 100
                        ? sanitizeInput(eventName.substring(0, 100))
                        : sanitizeInput(eventName);

                    // Get event details
                    const eventDetails = {
                        date: document.getElementById('eventDate').value || '',
                        time: document.getElementById('eventTime').value || '',
                        location: sanitizeInput(document.getElementById('eventLocation').value.trim()),
                        address: sanitizeInput(document.getElementById('eventAddress').value.trim()),
                        notes: sanitizeInput(document.getElementById('eventNotes').value.trim()),
                        maxAttendees: document.getElementById('maxAttendees').value || ''
                    };

                    const updates = {
                        eventName: sanitizedEventName,
                        eventDetails: eventDetails,
                        cars: cars,
                        unassignedPassengers: unassignedPassengers,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    };

                    database.ref(`shared/${shareId}`).update(updates).then(() => {
                        console.log('Shared event updated!');
                        setTimeout(() => {
                            isSaving = false;
                        }, 500);
                    }).catch(error => {
                        console.error('Error updating shared event:', error);
                        isSaving = false;
                    });
                };
            }
        }

        function loadData() {
            // Real-time listener - updates whenever anyone makes a change!
            dbRef.on('value', (snapshot) => {
                // Don't update if we're currently saving
                if (isSaving) {
                    console.log('Skipping Firebase update - currently saving');
                    return;
                }

                const data = snapshot.val();

                // If no data exists yet (first time), just render empty state
                if (!data) {
                    console.log('No data in Firebase yet');
                    return;
                }

                console.log('Loading data from Firebase:', data);
                document.getElementById('eventName').value = data.eventName || '';

                // Load event details
                if (data.eventDetails) {
                    document.getElementById('eventDate').value = data.eventDetails.date || '';
                    document.getElementById('eventTime').value = data.eventDetails.time || '';
                    document.getElementById('eventLocation').value = data.eventDetails.location || '';
                    document.getElementById('eventAddress').value = data.eventDetails.address || '';
                    document.getElementById('eventNotes').value = data.eventDetails.notes || '';
                    document.getElementById('maxAttendees').value = data.eventDetails.maxAttendees || '';
                    document.getElementById('gasCost').value = data.eventDetails.gasCost || '';
                    document.getElementById('parkingFee').value = data.eventDetails.parkingFee || '';
                    document.getElementById('tollsFees').value = data.eventDetails.tollsFees || '';
                    document.getElementById('splitMethod').value = data.eventDetails.splitMethod || 'passengers-only';
                }

                cars = data.cars || [];
                unassignedPassengers = data.unassignedPassengers || [];

                // Ensure all cars have passengers arrays
                cars.forEach(car => {
                    if (!car.passengers) {
                        car.passengers = [];
                    }
                });

                renderCars();
                renderUnassigned();
                calculateCosts(); // Recalculate costs after loading data
            });
        }

        // Add auto-save to event name and event details inputs
        document.getElementById('eventName').addEventListener('input', autoSave);
        document.getElementById('eventDate').addEventListener('change', autoSave);
        document.getElementById('eventTime').addEventListener('change', autoSave);
        document.getElementById('eventLocation').addEventListener('input', autoSave);
        document.getElementById('eventAddress').addEventListener('input', autoSave);
        document.getElementById('eventNotes').addEventListener('input', autoSave);
        document.getElementById('maxAttendees').addEventListener('input', autoSave);

        // Allow Enter key to submit
        document.getElementById('driverName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('seatCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('passengerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addPassenger();
        });

        // Check for shared event on page load
        checkForSharedEvent();

        // Initial render
        renderCars();
        renderUnassigned();

        // DVD-style bouncing cookie
        const cookie = document.querySelector('.dancing-cookie');
        let x = Math.random() * (window.innerWidth - 100);
        let y = Math.random() * (window.innerHeight - 100);
        let xSpeed = 2;
        let ySpeed = 2;

        // Cookie menu functionality
        const cookieMenu = document.getElementById('cookieMenu');

        // TETRIS Easter Egg - Click cookie 6 times to spell TETRIS
        let cookieClickCount = 0;
        const tetrisLetters = ['S', 'I', 'R', 'T', 'E', 'T'];
        const tetrisRevealDiv = document.getElementById('tetrisReveal');
        let cookieResetTimer = null;

        cookie.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling

            // Don't show menu or start game if auth modal is showing
            const authOverlay = document.getElementById('authOverlay');
            if (authOverlay.classList.contains('active')) {
                return;
            }

            // Show menu centered on screen
            cookieMenu.classList.add('show');

            // Easter egg counter
            cookieClickCount++;

            // Reset timer - if you don't complete within 5 seconds, reset
            clearTimeout(cookieResetTimer);
            cookieResetTimer = setTimeout(() => {
                cookieClickCount = 0;
                tetrisRevealDiv.textContent = '';
            }, 5000);

            if (cookieClickCount <= 6) {
                // Build up TETRIS letter by letter
                const currentWord = tetrisLetters.slice(0, cookieClickCount).join('');
                tetrisRevealDiv.textContent = currentWord;

                if (cookieClickCount === 6) {
                    // Spell complete! Launch game
                    clearTimeout(cookieResetTimer);
                    closeCookieMenu();

                    setTimeout(() => {
                        tetrisRevealDiv.textContent = '';
                        cookieClickCount = 0;
                        openTetris();
                    }, 500);
                }
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!cookieMenu.contains(e.target) && e.target !== cookie) {
                cookieMenu.classList.remove('show');
            }
        });

        function closeCookieMenu() {
            cookieMenu.classList.remove('show');
        }

        function moveCookie() {
            x += xSpeed;
            y += ySpeed;

            const cookieSize = 64; // Approximate size of the emoji

            // Bounce off edges
            if (x + cookieSize >= window.innerWidth || x <= 0) {
                xSpeed = -xSpeed;
            }
            if (y + cookieSize >= window.innerHeight || y <= 0) {
                ySpeed = -ySpeed;
            }

            cookie.style.left = x + 'px';
            cookie.style.top = y + 'px';

            requestAnimationFrame(moveCookie);
        }

        moveCookie();

        // ============================================
        // TETRIS EASTER EGG - GAME BOY STYLE
        // ============================================

        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 20;
        const COLORS = ['#0f380f', '#306230', '#0f380f', '#8bac0f', '#9bbc0f'];

        let tetrisCanvas, tetrisCtx;
        let tetrisBoard = [];
        let currentPiece = null;
        let tetrisScore = 0;
        let tetrisLevel = 1;
        let tetrisGameRunning = false;
        let tetrisGameLoop = null;
        let tetrisPaused = false;
        let tetrisDropCounter = 0;
        let tetrisDropInterval = 1000;

        // Tetris pieces (tetrominoes)
        const PIECES = {
            I: [[1,1,1,1]],
            O: [[1,1],[1,1]],
            T: [[0,1,0],[1,1,1]],
            S: [[0,1,1],[1,1,0]],
            Z: [[1,1,0],[0,1,1]],
            J: [[1,0,0],[1,1,1]],
            L: [[0,0,1],[1,1,1]]
        };

        function initTetris() {
            tetrisCanvas = document.getElementById('tetrisCanvas');
            tetrisCtx = tetrisCanvas.getContext('2d');

            // Initialize board
            tetrisBoard = Array(ROWS).fill().map(() => Array(COLS).fill(0));

            tetrisScore = 0;
            tetrisLevel = 1;
            updateTetrisUI();

            spawnPiece();

            // Music already started on cookie click - don't start again
        }

        function spawnPiece() {
            const pieces = Object.keys(PIECES);
            const randomPiece = pieces[Math.floor(Math.random() * pieces.length)];
            currentPiece = {
                shape: PIECES[randomPiece],
                x: Math.floor(COLS / 2) - 1,
                y: 0,
                color: 1
            };

            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                // Game over
                tetrisGameRunning = false;
                alert('Game Over! Score: ' + tetrisScore);
                closeTetris();
            }
        }

        function collision(x, y, shape) {
            for (let row = 0; row < shape.length; row++) {
                for (let col = 0; col < shape[row].length; col++) {
                    if (shape[row][col] &&
                        (y + row >= ROWS ||
                         x + col < 0 ||
                         x + col >= COLS ||
                         tetrisBoard[y + row] && tetrisBoard[y + row][x + col])) {
                        return true;
                    }
                }
            }
            return false;
        }

        function merge() {
            currentPiece.shape.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value) {
                        tetrisBoard[currentPiece.y + y][currentPiece.x + x] = currentPiece.color;
                    }
                });
            });
        }

        function rotate(shape) {
            const rotated = shape[0].map((_, i) =>
                shape.map(row => row[i]).reverse()
            );
            return rotated;
        }

        function clearLines() {
            let linesCleared = 0;
            for (let row = ROWS - 1; row >= 0; row--) {
                if (tetrisBoard[row].every(cell => cell !== 0)) {
                    tetrisBoard.splice(row, 1);
                    tetrisBoard.unshift(Array(COLS).fill(0));
                    linesCleared++;
                    row++; // Check same row again
                }
            }
            if (linesCleared > 0) {
                tetrisScore += linesCleared * 100 * tetrisLevel;
                tetrisLevel = Math.floor(tetrisScore / 1000) + 1;
                tetrisDropInterval = Math.max(100, 1000 - (tetrisLevel * 100));
                updateTetrisUI();
            }
        }

        function movePiece(dir) {
            currentPiece.x += dir;
            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                currentPiece.x -= dir;
            }
        }

        function dropPiece() {
            currentPiece.y++;
            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                currentPiece.y--;
                merge();
                clearLines();
                spawnPiece();
            }
            tetrisDropCounter = 0;
        }

        function hardDrop() {
            while (!collision(currentPiece.x, currentPiece.y + 1, currentPiece.shape)) {
                currentPiece.y++;
            }
            merge();
            clearLines();
            spawnPiece();
        }

        function rotatePiece() {
            const rotated = rotate(currentPiece.shape);
            if (!collision(currentPiece.x, currentPiece.y, rotated)) {
                currentPiece.shape = rotated;
            }
        }

        function drawTetris() {
            // Clear canvas with Game Boy green
            tetrisCtx.fillStyle = '#0f380f';
            tetrisCtx.fillRect(0, 0, tetrisCanvas.width, tetrisCanvas.height);

            // Draw board
            tetrisBoard.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell) {
                        drawBlock(x, y, '#8bac0f');
                    }
                });
            });

            // Draw current piece
            if (currentPiece) {
                currentPiece.shape.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            drawBlock(currentPiece.x + x, currentPiece.y + y, '#9bbc0f');
                        }
                    });
                });
            }
        }

        function drawBlock(x, y, color) {
            tetrisCtx.fillStyle = color;
            tetrisCtx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
            tetrisCtx.strokeStyle = '#306230';
            tetrisCtx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
        }

        function updateTetrisUI() {
            document.getElementById('tetrisScore').textContent = tetrisScore;
            document.getElementById('tetrisLevel').textContent = tetrisLevel;
        }

        function tetrisUpdate(deltaTime) {
            if (!tetrisGameRunning || tetrisPaused) return;

            tetrisDropCounter += deltaTime;
            if (tetrisDropCounter > tetrisDropInterval) {
                dropPiece();
            }

            drawTetris();
        }

        let lastTetrisTime = 0;
        function tetrisLoop(time = 0) {
            const deltaTime = time - lastTetrisTime;
            lastTetrisTime = time;

            tetrisUpdate(deltaTime);

            if (tetrisGameRunning) {
                tetrisGameLoop = requestAnimationFrame(tetrisLoop);
            }
        }

        // Tetris controls
        document.addEventListener('keydown', (e) => {
            if (!tetrisGameRunning) return;

            switch(e.key) {
                case 'ArrowLeft':
                    movePiece(-1);
                    break;
                case 'ArrowRight':
                    movePiece(1);
                    break;
                case 'ArrowDown':
                    dropPiece();
                    break;
                case 'ArrowUp':
                    rotatePiece();
                    break;
                case ' ':
                    tetrisPaused = !tetrisPaused;
                    break;
            }
        });

        function openTetris() {
            document.getElementById('tetrisOverlay').classList.add('active');
            document.getElementById('mobileControls').classList.add('active');
            tetrisGameRunning = true;
            initTetris();
            tetrisLoop();

            // Play the 8-bit MP3 track
            const mp3Player = document.getElementById('mp3Player');
            mp3Player.volume = 0.3; // Set volume to 30%
            mp3Player.play().catch(err => {
                console.log('Audio play failed:', err);
                document.getElementById('musicPrompt').classList.add('show');
            });
        }

        function closeTetris() {
            document.getElementById('tetrisOverlay').classList.remove('active');
            document.getElementById('mobileControls').classList.remove('active');
            document.getElementById('musicPrompt').classList.remove('show');
            tetrisGameRunning = false;
            if (tetrisGameLoop) {
                cancelAnimationFrame(tetrisGameLoop);
            }

            // Stop the MP3 player
            const mp3Player = document.getElementById('mp3Player');
            mp3Player.pause();
            mp3Player.currentTime = 0;
        }

        // Mobile touch controls - also resume audio on first touch (iOS fix)
        function handleTouchControl(callback) {
            return function(e) {
                e.preventDefault();

                // Try to play MP3 on first touch (iOS requirement)
                const mp3Player = document.getElementById('mp3Player');
                if (mp3Player.paused) {
                    mp3Player.play().then(() => {
                        document.getElementById('musicPrompt').classList.remove('show');
                    }).catch(err => {
                        console.log('Audio play failed on touch:', err);
                    });
                }

                if (tetrisGameRunning) callback();
            };
        }

        document.getElementById('btnLeft').addEventListener('touchstart', handleTouchControl(() => movePiece(-1)));
        document.getElementById('btnRight').addEventListener('touchstart', handleTouchControl(() => movePiece(1)));
        document.getElementById('btnDown').addEventListener('touchstart', handleTouchControl(() => dropPiece()));
        document.getElementById('btnRotate').addEventListener('touchstart', handleTouchControl(() => rotatePiece()));

        // Desktop shortcut: Press 'T' three times quickly
        let tPressCount = 0;
        let tPressTimer = null;
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                tPressCount++;
                clearTimeout(tPressTimer);

                if (tPressCount >= 3 && !tetrisGameRunning) {
                    tPressCount = 0;
                    openTetris();
                } else {
                    tPressTimer = setTimeout(() => {
                        tPressCount = 0;
                    }, 1000);
                }
            }
        });
    </script>
</body>
</html>
